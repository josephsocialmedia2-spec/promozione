<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Video Creator ‚Äì Teleprompter Professionale</title>
  <meta name="description" content="Crea video immobiliari professionali con teleprompter integrato per TikTok, Instagram, Reels e Shorts">
  <meta name="keywords" content="video creator, teleprompter, immobiliare, social media, content creation">
  
  <style>
    /* ===== VARIABLES ===== */
    :root {
      /* Colori semantici */
      --bg: #0b1120;
      --bg-secondary: #0f172a;
      --text: #f3f4f6;
      --text-secondary: #a0adb8;
      --primary: #d8a23a;
      --primary-light: rgba(216, 162, 58, 0.15);
      --danger: #ff2d2d;
      --danger-light: rgba(255, 45, 45, 0.15);
      --success: #4a8f72;
      --info: #395a8c;
      --warning: #d8a23a;
      --border: rgba(225, 225, 225, 0.18);
      --border-light: rgba(255, 255, 255, 0.08);
      
      /* Spaziature */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 24px;
      
      /* Raggi bordi */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 18px;
      --radius-xl: 24px;
      
      /* Ombre */
      --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.25);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.35);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.45);
      
      /* Font */
      --font-sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      
      /* Teleprompter */
      --tele-font: 12px;
      --tele-line: 1.22;
      --stage-w: min(420px, 92vw);
      --zoom: 1;
      
      /* Breakpoints */
      --bp-mobile: 480px;
      --bp-tablet: 768px;
      --bp-desktop: 1024px;
      
      /* Transizioni */
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
      --transition-slow: 0.35s ease;
    }
    
    /* ===== RESET & BASE ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: var(--font-sans);
      color: var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(216, 162, 58, .18), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(123, 79, 189, .14), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(74, 143, 114, .14), transparent 55%),
        var(--bg);
      line-height: 1.5;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* ===== LAYOUT ===== */
    .wrap {
      max-width: 1150px;
      margin: 0 auto;
      padding: var(--spacing-md) var(--spacing-sm) 84px;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      flex-wrap: wrap;
      margin-bottom: var(--spacing-md);
    }
    
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: center;
    }
    
    .layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: var(--spacing-md);
      align-items: start;
      margin-top: var(--spacing-md);
    }
    
    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    
    /* ===== TYPOGRAPHY ===== */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
      line-height: 1.2;
    }
    
    .h {
      margin: 0 0 var(--spacing-sm);
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 950;
    }
    
    .subtle {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.35;
      margin-top: var(--spacing-sm);
    }
    
    /* ===== BUTTONS ===== */
    .btn {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .04);
      color: var(--text);
      padding: 8px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      font-size: 11px;
      line-height: 1;
      white-space: nowrap;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      user-select: none;
      position: relative;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      min-height: 36px;
      min-width: 44px;
      outline: none;
    }
    
    .btn:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(216, 162, 58, 0.3);
    }
    
    .btn::after {
      content: "";
      position: absolute;
      inset: -2px;
      background: radial-gradient(500px 140px at 20% 0%, rgba(255, 255, 255, .14), transparent 60%),
                  radial-gradient(500px 140px at 80% 100%, rgba(255, 255, 255, .10), transparent 55%);
      opacity: 0;
      transition: opacity var(--transition-normal);
      pointer-events: none;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      border-color: rgba(216, 162, 58, .22);
      box-shadow: var(--shadow-md);
      filter: brightness(1.1);
    }
    
    .btn:hover::after {
      opacity: 1;
    }
    
    .btn:active {
      transform: translateY(0);
      filter: brightness(0.95);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .btn.loading {
      position: relative;
      color: transparent;
    }
    
    .btn.loading::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .btn.tiny {
      padding: 6px 10px;
      font-size: 10px;
      min-height: 32px;
    }
    
    .btn.primary {
      background: linear-gradient(135deg, rgba(216, 162, 58, .95), rgba(216, 162, 58, .72));
      color: #111;
      border-color: rgba(216, 162, 58, .55);
    }
    
    .btn.blue {
      background: linear-gradient(135deg, rgba(57, 90, 140, .95), rgba(57, 90, 140, .70));
      border-color: rgba(57, 90, 140, .55);
    }
    
    .btn.violet {
      background: linear-gradient(135deg, rgba(123, 79, 189, .95), rgba(123, 79, 189, .70));
      border-color: rgba(123, 79, 189, .55);
    }
    
    .btn.gray {
      background: rgba(255, 255, 255, .04);
    }
    
    .btn.rec {
      background: linear-gradient(135deg, rgba(255, 45, 45, .95), rgba(255, 45, 45, .55));
      border-color: rgba(255, 45, 45, .55);
      color: #120707;
      font-weight: 700;
    }
    
    .btn.rec .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #ff2d2d;
      box-shadow: 0 0 0 0 rgba(255, 45, 45, .45);
      animation: pulseDot 1.15s ease-in-out infinite;
    }
    
    @keyframes pulseDot {
      0% { box-shadow: 0 0 0 0 rgba(255, 45, 45, .45); transform: scale(1); }
      60% { box-shadow: 0 0 0 10px rgba(255, 45, 45, 0); transform: scale(1.06); }
      100% { box-shadow: 0 0 0 0 rgba(255, 45, 45, 0); transform: scale(1); }
    }
    
    .btn .ico {
      display: inline-flex;
      transform: translateY(0);
      transition: transform var(--transition-normal);
    }
    
    .btn:hover .ico {
      transform: translateY(-1px) rotate(-2deg);
    }
    
    /* ===== FORMS ===== */
    .field {
      margin-bottom: var(--spacing-md);
    }
    
    .field textarea,
    .field input,
    .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: rgba(0, 0, 0, .18);
      color: var(--text);
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 500;
      transition: all var(--transition-normal);
      outline: none;
      resize: vertical;
    }
    
    .field textarea:focus,
    .field input:focus,
    .field select:focus {
      border-color: rgba(216, 162, 58, .45);
      box-shadow: 0 0 0 3px rgba(216, 162, 58, .12);
    }
    
    .field textarea {
      min-height: 120px;
      line-height: 1.25;
    }
    
    /* ===== CARDS ===== */
    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .02));
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }
    
    .section {
      padding: var(--spacing-md);
    }
    
    .section + .section {
      border-top: 1px solid rgba(255, 255, 255, .10);
    }
    
    /* ===== STAGE & TELEPROMPTER ===== */
    .stageRow {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
      align-items: start;
    }
    
    @media (max-width: 980px) {
      .stageRow {
        grid-template-columns: 1fr;
      }
    }
    
    .stageBlock {
      width: var(--stage-w);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    
    #stage916 {
      width: 100%;
      aspect-ratio: 9 / 16;
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: var(--radius-lg);
      overflow: hidden;
      position: relative;
      background: #000;
      box-shadow: var(--shadow-lg);
    }
    
    #cam {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scale(var(--zoom));
      transform-origin: center;
    }
    
    #overlay {
      position: absolute;
      inset: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      pointer-events: none;
      z-index: 2;
    }
    
    #questionBoxOverlay {
      font-size: 11px;
      font-weight: 600;
      line-height: 1.15;
      padding: 7px 9px;
      border-radius: var(--radius-md);
      background: rgba(0, 0, 0, .30);
      border: 1px solid rgba(255, 255, 255, .14);
      backdrop-filter: blur(6px);
      white-space: pre-wrap;
    }
    
    #teleprompterOverlay {
      flex: 1;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-md);
    }
    
    #teleText {
      position: absolute;
      left: 0;
      right: 0;
      white-space: pre-wrap;
      font-size: var(--tele-font);
      line-height: var(--tele-line);
      font-weight: 600;
      color: rgba(243, 244, 246, .94);
      text-shadow: 0 2px 12px rgba(0, 0, 0, .75);
      transform: translateY(20px);
    }
    
    /* ===== CONTROLS ===== */
    .controlsRow {
      margin-top: var(--spacing-md);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      align-items: stretch;
    }
    
    .bar {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      align-items: center;
    }
    
    .bar.left {
      justify-content: flex-start;
    }
    
    .bar.between {
      justify-content: space-between;
    }
    
    .sliderRow {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      color: var(--text-secondary);
      font-size: 10px;
      font-weight: 600;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    input[type="range"] {
      width: 170px;
      accent-color: var(--primary);
      cursor: pointer;
    }
    
    /* ===== CHECKBOXES & PILLS ===== */
    .chk {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      user-select: none;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 10px;
      white-space: nowrap;
    }
    
    .check {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
      cursor: pointer;
    }
    
    .pill {
      font-size: 10px;
      color: var(--text-secondary);
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(0, 0, 0, .18);
      font-weight: 600;
      letter-spacing: .2px;
      display: inline-flex;
      gap: var(--spacing-sm);
      align-items: center;
      white-space: nowrap;
    }
    
    /* ===== PROFILES ===== */
    .profiles {
      display: grid;
      grid-template-columns: 1fr;
      gap: 7px;
      margin-top: var(--spacing-sm);
    }
    
    .profileRow {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      padding: 7px 8px;
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: var(--radius-md);
      background: rgba(0, 0, 0, .14);
      transition: all var(--transition-fast);
    }
    
    .profileRow:hover {
      background: rgba(0, 0, 0, .2);
    }
    
    .profileMeta {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      min-width: 0;
      flex: 1;
    }
    
    .profileMeta b {
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .nextBadge {
      font-size: 9px;
      font-weight: 700;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255, 45, 45, .55);
      color: rgba(255, 235, 235, .95);
      background: rgba(255, 45, 45, .18);
      white-space: nowrap;
      display: none;
      pointer-events: none;
      user-select: none;
    }
    
    .nextBadge.show {
      display: inline-flex;
    }
    
    /* ===== REC LAMP ===== */
    #recLamp {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 7px 9px;
      border-radius: var(--radius-md);
      background: rgba(0, 0, 0, .40);
      border: 1px solid rgba(255, 255, 255, .18);
      font-weight: 600;
      font-size: 11px;
      display: none;
      align-items: center;
      gap: var(--spacing-sm);
      backdrop-filter: blur(6px);
      z-index: 6;
    }
    
    /* ===== BOTTOM BAR ===== */
    .bottomBar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 12px;
      background: rgba(0, 0, 0, .35);
      border-top: 1px solid rgba(255, 255, 255, .12);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: flex-end;
      z-index: 50;
    }
    
    /* ===== DETAILS/SECTION ===== */
    details {
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: var(--radius-md);
      background: rgba(0, 0, 0, .14);
      padding: var(--spacing-md);
      transition: all var(--transition-normal);
    }
    
    details[open] {
      background: rgba(0, 0, 0, .2);
    }
    
    summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      user-select: none;
      font-weight: 600;
      color: var(--text);
      font-size: 11px;
    }
    
    summary::-webkit-details-marker {
      display: none;
    }
    
    summary::after {
      content: "‚ñº";
      font-size: 10px;
      transition: transform var(--transition-normal);
    }
    
    details[open] summary::after {
      transform: rotate(180deg);
    }
    
    /* ===== CODE & MINI ===== */
    .codeRow {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      align-items: center;
      margin-top: var(--spacing-md);
    }
    
    .mini {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
      background: rgba(0, 0, 0, .18);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
    }
    
    /* ===== GRID LAYOUTS ===== */
    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-sm);
    }
    
    @media (max-width: 420px) {
      .grid2 {
        grid-template-columns: 1fr;
      }
    }
    
    /* ===== CONTROL GROUPS ===== */
    .ctrlLeft {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }
    
    .ctrlMid {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      justify-content: center;
    }
    
    .ctrlRight {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      justify-content: flex-end;
      margin-left: auto;
    }
    
    /* ===== NOTIFICATIONS ===== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-md);
      background: rgba(0, 0, 0, .8);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      box-shadow: var(--shadow-lg);
      max-width: 300px;
    }
    
    .notification.success { border-left: 4px solid var(--success); }
    .notification.error   { border-left: 4px solid var(--danger); }
    .notification.info    { border-left: 4px solid var(--info); }
    .notification.warning { border-left: 4px solid var(--warning); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to   { transform: translateX(0); opacity: 1; }
    }
    
    /* ===== MODAL ===== */
    .modalBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: var(--spacing-md);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modalBackdrop.show { display: flex; }
    
    .modalCard {
      width: min(920px, 96vw);
      max-height: min(82vh, 780px);
      overflow: auto;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, .14);
      background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(0, 0, 0, .25));
      box-shadow: 0 18px 70px rgba(0, 0, 0, .55);
      animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }
    
    .modalHead {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      border-bottom: 1px solid rgba(255, 255, 255, .10);
    }
    
    .modalHead h3 {
      margin: 0;
      font-size: 12px;
      letter-spacing: .7px;
      text-transform: uppercase;
      color: var(--text-secondary);
      font-weight: 700;
    }
    
    .modalBody {
      padding: var(--spacing-md);
      font-size: 12px;
      line-height: 1.35;
      color: var(--text);
    }
    
    .modalBody .k { color: var(--primary); font-weight: 600; }
    
    .modalBody ul { margin: var(--spacing-sm) 0 var(--spacing-md) 18px; }
    .modalBody li { margin: 6px 0; }
    
    .hr {
      height: 1px;
      background: rgba(255, 255, 255, .10);
      margin: var(--spacing-md) 0;
    }
    
    /* ===== MOBILE OPTIMIZATIONS ===== */
    @media (max-width: 768px) {
      .btn { min-height: 44px; font-size: 12px; }
      input, select, textarea { font-size: 16px; }
      .layout { gap: var(--spacing-sm); }
      .stageBlock { width: 100%; }
    }
    
    @media (max-width: 480px) {
      .wrap { padding: var(--spacing-sm) var(--spacing-xs) 70px; }
      .btn { flex: 1; min-width: 0; }
      .row { justify-content: center; }
      .bar { justify-content: center; }
    }
    
    /* ===== DARK MODE ADJUSTMENTS ===== */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0a0a0a;
        --bg-secondary: #111827;
        --border: rgba(255, 255, 255, .15);
        --border-light: rgba(255, 255, 255, .05);
      }
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="row" style="flex:1;">
      <button class="btn primary" id="btnNext" type="button" 
              aria-label="Genera nuova domanda" aria-describedby="hintTop">
        <span class="ico" aria-hidden="true">‚ú®</span> Nuova domanda
      </button>

      <button class="btn blue" id="btnOpenChatGPTPasteQ" type="button" 
              title="Copia PROMPT + domanda e apre ChatGPT">
        <span class="ico" aria-hidden="true">üí¨</span> Apri ChatGPT + copia domanda
      </button>

      <button class="btn violet" id="btnPasteTop" type="button" 
              title="Incolla dagli appunti nel blocco risposta qui sotto">
        <span class="ico" aria-hidden="true">üìã</span> Incolla risposta
      </button>

      <button class="btn gray" id="btnInstructions" type="button" 
              title="Apri le istruzioni operative">
        <span class="ico" aria-hidden="true">üìñ</span> Istruzioni
      </button>

      <span class="pill">
        <span id="videoCounter">Video: 0</span>
        <span aria-hidden="true">‚Ä¢</span>
        <span id="activeProfileLabel">Prossimo: ‚Äî</span>
      </span>
    </div>

    <div class="row">
      <button class="btn tiny gray" id="btnBackTop" type="button">‚Üê Gestionale</button>
    </div>
  </header>

  <div class="hintTop" id="hintTop">
    1) <b>Nuova domanda</b> ‚Üí 2) <b>Apri ChatGPT + copia domanda</b> (incolla e invia) ‚Üí 3) usa <b>copia</b> su ChatGPT ‚Üí
    4) <b>Incolla risposta</b> ‚Üí 5) <b>Teleprompter + REC</b>
  </div>

  <!-- DATI IMMOBILE -->
  <div class="card">
    <div class="section">
      <p class="h">Dati immobile (inseriti dal cliente)</p>

      <div class="grid2">
        <div class="field">
          <input id="f_displayName" placeholder="Nome visualizzato (es: Trilocale Luminoso)" 
                 aria-label="Nome visualizzato dell'immobile" />
        </div>
        <div class="field">
          <input id="f_mq" type="number" min="0" step="1" placeholder="Metri Quadri (mq)" 
                 aria-label="Metri quadri dell'immobile" />
        </div>

        <div class="field">
          <input id="f_piano" placeholder="Piano (es: 2¬∞ / rialzato / terra)" 
                 aria-label="Piano dell'immobile" />
        </div>
        <div class="field">
          <input id="f_locali" placeholder="Locali (es: 3 / bilocale / trilocale)" 
                 aria-label="Numero di locali" />
        </div>

        <div class="field">
          <input id="f_bagno" placeholder="Bagno/i (es: 1 / 2 / 1 finestrato)" 
                 aria-label="Numero di bagni" />
        </div>
        <div class="field">
          <input id="f_riscaldamento" placeholder="Riscaldamento (es: autonomo / centralizzato)" 
                 aria-label="Tipo di riscaldamento" />
        </div>

        <div class="field">
          <select id="f_giardino" aria-label="Presenza di giardino">
            <option value="">Giardino (seleziona)</option>
            <option value="S√¨">S√¨</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="field">
          <select id="f_garage" aria-label="Presenza di garage o box">
            <option value="">Garage/box (seleziona)</option>
            <option value="S√¨">S√¨</option>
            <option value="No">No</option>
          </select>
        </div>

        <div class="field">
          <select id="f_arredamento" aria-label="Stato di arredamento">
            <option value="">Arredamento (seleziona)</option>
            <option value="Arredato">Arredato</option>
            <option value="Parzialmente arredato">Parzialmente arredato</option>
            <option value="Non arredato">Non arredato</option>
          </select>
        </div>
        <div class="field">
          <select id="f_ascensore" aria-label="Presenza di ascensore">
            <option value="">Ascensore (seleziona)</option>
            <option value="S√¨">S√¨</option>
            <option value="No">No</option>
          </select>
        </div>

        <div class="field">
          <select id="f_libero" aria-label="Disponibilit√† dell'immobile">
            <option value="">Libero (seleziona)</option>
            <option value="Subito">Subito</option>
            <option value="Da concordare">Da concordare</option>
            <option value="Occupato">Occupato</option>
          </select>
        </div>
        <div class="field">
          <input id="f_classeImmobile" placeholder="Classe Immobile (es: A4 / B / C ...)" 
                 aria-label="Classe energetica immobile" />
        </div>

        <div class="field">
          <input id="f_anno" type="number" min="0" step="1" placeholder="Anno di Costruzione (es: 1998)" 
                 aria-label="Anno di costruzione" />
        </div>
        <div class="field">
          <select id="f_ristrutturato" aria-label="Stato di ristrutturazione">
            <option value="">Ristrutturato (seleziona)</option>
            <option value="S√¨">S√¨</option>
            <option value="No">No</option>
            <option value="Parzialmente">Parzialmente</option>
          </select>
        </div>
      </div>

      <div class="bar left" style="margin-top:10px;">
        <button class="btn tiny gray" id="btnClearProperty" type="button">üßπ Svuota dati</button>
        <span class="pill" id="propertyStatus">Dati: ‚Äî</span>
      </div>

      <div class="subtle">
        Questi dati vengono aggiunti automaticamente al testo che copi su ChatGPT.
      </div>
    </div>
  </div>

  <!-- BLOCCO RISPOSTA IN ALTO -->
  <div class="card">
    <div class="section">
      <p class="h">Risposta (da ChatGPT o scritta da te)</p>
      <div class="field">
        <textarea id="answerBox" 
                  placeholder="Qui verr√† incollata la risposta quando premi &quot;Incolla risposta&quot;‚Ä¶"
                  aria-label="Area di testo per la risposta"></textarea>
      </div>

      <div class="bar left" style="margin-top:10px;">
        <button class="btn primary" id="btnSendTele" type="button">
          <span class="ico" aria-hidden="true">‚û°Ô∏è</span> Invia al teleprompter
        </button>
        <button class="btn gray" id="btnCopyCaption" type="button" 
                title="Copia caption con hashtag (se non gi√† presenti)">
          <span class="ico" aria-hidden="true">üìã</span> Copia caption
        </button>
      </div>

      <div class="subtle">
        "Invia al teleprompter" ti permette anche di inserire messaggi scritti da te (non solo incollati da ChatGPT).
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- MAIN -->
    <div class="card">
      <div class="section">
        <p class="h">Video 9:16 + teleprompter</p>

        <div class="stageRow">
          <div class="stageBlock">
            <div id="stage916" role="region" aria-label="Anteprima video e teleprompter">
              <video id="cam" autoplay playsinline muted aria-label="Streaming camera"></video>

              <div id="recLamp" aria-live="polite" aria-atomic="true">
                <span style="width:10px;height:10px;border-radius:999px;background:#ff2d2d;display:inline-block;"></span>
                <span id="recTime">REC 00:00</span>
              </div>

              <div id="overlay">
                <div id="questionBoxOverlay" role="status">Premi "Nuova domanda".</div>
                <div id="teleprompterOverlay">
                  <div id="teleText" aria-label="Testo del teleprompter">
                    Incolla/scrivi una risposta in alto ‚Üí "Invia al teleprompter" ‚Üí "Teleprompter + REC".
                  </div>
                </div>
              </div>
            </div>

            <div class="controlsRow">
              <div class="bar between" style="width:100%;">
                <div class="ctrlLeft">
                  <button class="btn gray" id="btnCam" type="button">
                    <span class="ico" aria-hidden="true">üì∑</span> Camera
                  </button>
                </div>

                <div class="ctrlMid">
                  <button class="btn gray" id="btnStop" type="button">
                    <span class="ico" aria-hidden="true">‚èπ</span> Stop
                  </button>
                  <button class="btn gray" id="btnRestart" type="button">
                    <span class="ico" aria-hidden="true">‚Üª</span> Riavvia
                  </button>
                </div>

                <div class="ctrlRight">
                  <button class="btn rec" id="btnTeleRec" type="button" 
                          title="Avvia teleprompter e registrazione">
                    <span class="dot" aria-hidden="true"></span> Teleprompter + REC
                  </button>
                </div>
              </div>

              <div class="bar">
                <label class="chk">
                  <input class="check" type="radio" name="speed" id="speed120" value="120"> 120
                </label>
                <label class="chk">
                  <input class="check" type="radio" name="speed" id="speed105" value="105" checked> 105
                </label>
                <label class="chk">
                  <input class="check" type="radio" name="speed" id="speed90" value="90"> 90
                </label>
                <span class="pill" id="speedLabel">Vel: 105s</span>
              </div>

              <div class="sliderRow">
                <span>Zoom</span>
                <input id="zoom" type="range" min="1" max="2.5" step="0.1" value="1" 
                       aria-label="Livello di zoom camera" />
                <span id="zoomVal">1.0x</span>
              </div>
            </div>
          </div>

          <div>
            <p class="h">Rotazione profili (piccola)</p>
            <div class="profiles">
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_tiktok" checked 
                       aria-label="Includi TikTok nella rotazione">
                <div class="profileMeta"><b>üì± TikTok</b></div>
                <span class="nextBadge" id="badge_tiktok">PROSSIMO</span>
              </div>
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_instagram" checked 
                       aria-label="Includi Instagram nella rotazione">
                <div class="profileMeta"><b>üì∏ Instagram</b></div>
                <span class="nextBadge" id="badge_instagram">PROSSIMO</span>
              </div>
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_shorts" 
                       aria-label="Includi Shorts nella rotazione">
                <div class="profileMeta"><b>üé• Shorts</b></div>
                <span class="nextBadge" id="badge_shorts">PROSSIMO</span>
              </div>
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_facebook" 
                       aria-label="Includi Facebook nella rotazione">
                <div class="profileMeta"><b>üíº Facebook</b></div>
                <span class="nextBadge" id="badge_facebook">PROSSIMO</span>
              </div>
            </div>

            <div class="subtle">
              Seleziona i canali da includere. "PROSSIMO" √® solo un indicatore (non cliccabile).
            </div>
          </div>
        </div>

        <canvas id="recCanvas" width="1080" height="1920" style="display:none;" 
                aria-hidden="true"></canvas>
      </div>
    </div>

    <!-- SIDE -->
    <div class="card">
      <div class="section">
        <div class="bar between">
          <p class="h" style="margin:0;">Caption (memorizzata)</p>
          <label class="chk" title="Memorizza la caption (senza hashtag) per il prossimo avvio">
            <input type="checkbox" id="chkRememberCaption" class="check" checked 
                   aria-label="Memorizza automaticamente la caption" />
            Memorizza
          </label>
        </div>

        <div class="mini" id="captionPreview" style="margin-top:10px;" 
             aria-label="Anteprima caption">‚Äî</div>
        <div class="subtle">Gli hashtag automatici vengono aggiunti solo in copia (se non gi√† presenti).</div>
      </div>

      <div class="section">
        <p class="h">Video creati</p>
        <div class="subtle">Seleziona un elemento (qui sotto) per rivederlo.</div>

        <video id="playback" controls style="width:100%; border-radius:14px; background:#000; margin-top:10px;" 
               aria-label="Player per riproduzione video"></video>

        <div class="bar left" style="margin-top:10px;">
          <button class="btn" id="btnDownloadVideo" type="button">
            <span class="ico" aria-hidden="true">üì•</span> Scarica video
          </button>
          <button class="btn tiny gray" id="btnClearList" type="button">üóëÔ∏è Svuota</button>
        </div>

        <div class="bar left" style="margin-top:10px;">
          <input id="uploadVideo" type="file" accept="video/*" style="display:none;" 
                 aria-label="Carica video" />
          <button class="btn" id="btnUploadVideo" type="button" 
                  title="Carica un video gi√† pronto (uso futuro)">
            <span class="ico" aria-hidden="true">‚¨ÜÔ∏è</span> Carica video
          </button>
          <span class="pill">Upload in lista</span>
        </div>

        <div class="mini" id="recList" style="margin-top:10px; max-height:260px; overflow:auto;" 
             role="list" aria-label="Lista video creati">‚Äî</div>
      </div>

      <div class="section">
        <details id="promptDetails">
          <summary>
            <span>üß† Prompt ChatGPT (clicca per aprire)</span>
            <span class="pill" id="promptStatePill">Bloccato</span>
          </summary>

          <div class="subtle">
            Questo prompt viene sempre inserito <b>prima</b> della domanda quando premi "Apri ChatGPT + copia domanda".
          </div>

          <div class="field" style="margin-top:10px;">
            <textarea id="promptBox" readonly 
                      aria-label="Prompt per ChatGPT"></textarea>
          </div>

          <div class="codeRow">
            <input id="unlockCode" placeholder="Codice per modificare il prompt" 
                   aria-label="Codice di sblocco prompt" />
            <button class="btn tiny primary" id="btnUnlock" type="button">Sblocca</button>
            <button class="btn tiny" id="btnSavePrompt" type="button" disabled>Salva</button>
            <button class="btn tiny" id="btnResetPrompt" type="button" disabled>Ripristina</button>
          </div>

          <div class="subtle">Per modificare serve il codice: <b>16091979Jm</b>.</div>
        </details>
      </div>
    </div>
  </div>
</div>

<!-- MODAL ISTRUZIONI -->
<div class="modalBackdrop" id="instructionsModal" aria-hidden="true" role="dialog" 
     aria-modal="true" aria-labelledby="instructionsTitle">
  <div class="modalCard">
    <div class="modalHead">
      <h3 id="instructionsTitle">Istruzioni operative ‚Ä¢ Video Creator</h3>
      <button class="btn tiny gray" id="btnCloseInstructions" type="button" 
              aria-label="Chiudi finestra istruzioni">‚úñ Chiudi</button>
    </div>

    <div class="modalBody">
      <div class="pill" style="display:inline-flex; margin-bottom:10px;">
        Obiettivo: <b style="color:var(--text);">domanda ‚Üí testo ‚Üí teleprompter ‚Üí video pronto</b>
      </div>

      <p style="margin:0 0 8px;">
        Questa dashboard serve a creare video verticali <span class="k">9:16</span> (TikTok/Instagram/Reels/Shorts) usando
        i <span class="k">dati immobile</span> + un testo generato con <span class="k">ChatGPT</span> + un <span class="k">teleprompter</span> integrato.
      </p>

      <div class="hr"></div>

      <p class="h" style="margin:0 0 8px;">Flusso in 5 passi</p>
      <ol style="margin: 0 0 12px 18px;">
        <li><b>Compila "Dati immobile"</b> (pi√π dati = testo migliore).</li>
        <li><b>Premi "Nuova domanda"</b> finch√© trovi la domanda giusta (tour, caption, investitori, ecc.).</li>
        <li><b>Premi "Apri ChatGPT + copia domanda"</b> ‚Üí incolla su ChatGPT ‚Üí invia ‚Üí copia la risposta.</li>
        <li><b>Premi "Incolla risposta"</b> e poi <b>"Invia al teleprompter"</b>.</li>
        <li><b>Premi "Teleprompter + REC"</b> per registrare con teleprompter e timer REC.</li>
      </ol>

      <div class="hr"></div>

      <p class="h" style="margin:0 0 8px;">Controlli principali</p>
      <ul>
        <li><b>Camera</b>: accende la camera/microfono.</li>
        <li><b>Velocit√† (90/105/120)</b>: regola lo scorrimento del teleprompter.</li>
        <li><b>Zoom</b>: ingrandisce l'inquadratura (utile per non far vedere troppo sfondo).</li>
        <li><b>Stop</b>: ferma la registrazione. <b>Riavvia</b>: ricomincia lo scorrimento del teleprompter.</li>
        <li><b>Rotazione profili</b>: seleziona i canali; "PROSSIMO" indica dove andr√† il video successivo.</li>
      </ul>

      <div class="hr"></div>

      <p class="h" style="margin:0 0 8px;">Caption & Hashtag</p>
      <ul>
        <li>La caption viene memorizzata automaticamente.</li>
        <li>Gli hashtag "fissi" vengono aggiunti solo quando premi <b>Copia caption</b> (se non sono gi√† presenti).</li>
      </ul>

      <div class="hr"></div>

      <p class="h" style="margin:0 0 8px;">Upload video (gi√† pronto per uso futuro)</p>
      <p style="margin:0;">
        Puoi caricare un video esterno: verr√† inserito in <b>Video creati</b> e lo potrai rivedere/scaricare come gli altri.
      </p>
    </div>
  </div>
</div>

<div class="bottomBar">
  <button class="btn tiny gray" id="btnBackBottom" type="button">‚Üê Gestionale</button>
</div>

<script>
// ==========================
// CONFIGURAZIONE PRINCIPALE
// ==========================
const CONFIG = {
  APP_NAME: 'Video Creator',
  VERSION: '1.0.0',
  
  // URLs
  GESTIONALE_URL: 'https://tuo-gestionale.com',
  CHATGPT_URL: 'https://chatgpt.com/c/69528e47-0920-8331-8d43-59824e8a9c54',
  
  // Hashtag automatici (NON mostrati in preview)
  HIDDEN_HASHTAGS: [
    "#immobiliarelasacra", "#josephcretorlab", "#realmediapro", "#amamy", "#immobiliare", "#realestateitalia",
    "#mercatoimmobiliare", "#agenziaimmobiliare", "#casainvendita", "#venditacasa", "#investimentiimmobiliari",
    "#property", "#realestate", "#digitalstrategist", "#digitalstrategy", "#marketingdigitale", "#strategiamarketing",
    "#brandstrategy", "#contentstrategy", "#socialmediastrategy", "#growthmarketing", "#personalbranding", "#branding",
    "#businessdigitale", "#marketingonline"
  ].join(" "),
  
  // Prompt base
  BASE_PROMPT: `üß© PROMPT ADATTIVO ‚Äì PROMO IMMOBILE (MAX 250 PAROLE + HASHTAG)

Agisci come un consulente immobiliare esperto e un copywriter per video social (TikTok/Instagram/Reels).
Devi creare testi brevi, chiari e super scorrevoli, adatti anche a un ragazzo di 15 anni.

Obiettivo: promuovere l'immobile usando i dati forniti (mq, piano, locali, ecc.) e trasformarli in una narrazione "vendibile".
Evita tecnicismi: se usi un termine tecnico, spiegalo subito in modo semplice.

Struttura di ogni risposta:
1) Hook iniziale (1-2 frasi che catturano l'attenzione)
2) Presentazione immobile (benefici concreti, non solo caratteristiche)
3) 2-3 punti forti in elenco (rapidi)
4) Chiusura con invito all'azione (scrivi "Scrivimi in DM" o "Chiamami")
5) Hashtag: 5 pertinenti + quelli fissi

Regole fondamentali:
- Massimo 250 parole, non di pi√π
- Tone: amichevole, rassicurante, professionale
- Niente linguaggio tecnico inutile`,
  
  // Codice sblocco prompt
  UNLOCK_CODE: '16091979Jm',
  
  // Domande
  QUESTION_BANK: [
    { q: "Scrivimi un testo per un video di 20-30 secondi che presenti questo immobile in modo super attraente." },
    { q: "Crea una caption Instagram persuasiva per questo immobile, con call-to-action forte." },
    { q: 'Fammi una versione pi√π emozionale e una pi√π "dati e concretezza" per lo stesso immobile.' },
    { q: 'Scrivi un testo stile "tour rapido" (come se stessi mostrando le stanze) per questo immobile.' },
    { q: "Scrivi una versione pensata per chi cerca prima casa (tono rassicurante)." },
    { q: "Scrivi una versione pensata per investitori (tono pratico, focalizzato sul valore)." },
  ],
  
  // Teleprompter
  TELEPROMPTER: {
    SPEEDS: [90, 105, 120],
    DEFAULT_SPEED: 105
  },
  
  // Video
  VIDEO: {
    WIDTH: 1080,
    HEIGHT: 1920,
    FPS: 30,
    MIME_TYPES: [
      'video/webm;codecs=vp9,opus',
      'video/webm;codecs=vp8,opus',
      'video/webm'
    ]
  }
};

// ==========================
// GESTIONE STATO
// ==========================
class AppState {
  constructor() {
    this.qIdx = -1;
    this.currentQuestion = '';
    this.lastCaptionClean = '';
    this.totalVideos = 0;
    this.rotationIndex = 0;
    this.promptText = '';
    this.camStream = null;
    this.chunks = [];
    this.rafCanvasId = null;
    this.zoomValue = 1.0;
    this.isTeleprompterRunning = false;
    this.startTimeSec = null;
    this.teleprompterAnimationId = null;
    this.isRecording = false;
    this.recorder = null;
    this.recStartTs = null;
    this.recTimerId = null;
    this.recordings = [];
    this.currentRecIndex = -1;
    this.teleprompterSeconds = CONFIG.TELEPROMPTER.DEFAULT_SPEED;
  }
}

// ==========================
// UTILITY FUNCTIONS
// ==========================
class Utilities {
  static $(id) {
    return document.getElementById(id);
  }

  static pad2(n) {
    return String(n).padStart(2, "0");
  }

  static nowStamp() {
    const d = new Date();
    return `${d.getFullYear()}-${this.pad2(d.getMonth()+1)}-${this.pad2(d.getDate())}-${this.pad2(d.getHours())}-${this.pad2(d.getMinutes())}-${this.pad2(d.getSeconds())}`;
  }

  static slugify(it) {
    return String(it || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9\s-]/g, "")
      .trim()
      .replace(/\s+/g, "-")
      .replace(/-+/g, "-")
      .slice(0, 50);
  }

  static keywordsFromQuestion(q) {
    const stop = new Set(["perche", "perch√©", "che", "cosa", "come", "se", "e", "o", "il", "lo", "la", "i", "gli", "le", "un", "una", "da", "di", "del", "della", "delle", "dei", "dello", "in", "su", "a", "al", "alla", "alle", "agli", "ai", "con", "senza", "poi", "subito", "solo", "nessuna", "nessun", "meglio", "ha", "senso", "dopo", "non", "piu", "pi√π", "anche"]);
    const words = this.slugify(q).split("-").filter(w => w && !stop.has(w));
    return words.slice(0, 4).join("-");
  }

  static async copyText(text) {
    const t = String(text || "");
    if (!t.trim()) return false;
    try {
      await navigator.clipboard.writeText(t);
      return true;
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      return true;
    }
  }

  static async readClipboardText() {
    try {
      return await navigator.clipboard.readText();
    } catch (error) {
      console.error('Errore lettura clipboard:', error);
      return '';
    }
  }

  static fmtTime(ms) {
    const sec = Math.floor(ms / 1000);
    const m = String(Math.floor(sec / 60)).padStart(2, "0");
    const s = String(sec % 60).padStart(2, "0");
    return `${m}:${s}`;
  }
}

// ==========================
// GESTIONE STORAGE
// ==========================
class StorageManager {
  static prefix = 'vc_';
  
  static set(key, value) {
    try {
      const data = JSON.stringify({
        value,
        timestamp: Date.now(),
        version: '1.0.0'
      });
      localStorage.setItem(this.prefix + key, data);
      return true;
    } catch (error) {
      console.warn('LocalStorage pieno o non disponibile:', error);
      return this.fallbackToSessionStorage(key, value);
    }
  }
  
  static get(key) {
    try {
      const data = localStorage.getItem(this.prefix + key);
      if (!data) return null;
      
      const parsed = JSON.parse(data);
      return parsed.value;
    } catch (error) {
      console.error('Errore lettura storage:', error);
      return null;
    }
  }
  
  static remove(key) {
    try {
      localStorage.removeItem(this.prefix + key);
    } catch (error) {
      console.error('Errore rimozione storage:', error);
    }
  }
  
  static fallbackToSessionStorage(key, value) {
    try {
      sessionStorage.setItem(this.prefix + key, JSON.stringify(value));
      return true;
    } catch (error) {
      console.error('Errore sessionStorage:', error);
      return false;
    }
  }
}

// ==========================
// GESTIONE NOTIFICHE
// ==========================
class NotificationManager {
  static show(message, type = 'info', duration = 5000) {
    const notification = document.createElement('div');
    // FIX: classi coerenti con CSS (.notification.success/.error/.info/.warning)
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.setAttribute('role', 'alert');
    notification.setAttribute('aria-live', 'polite');
    
    document.body.appendChild(notification);
    
    // Rimuovi dopo la durata
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => notification.remove(), 300);
    }, duration);
    
    return notification;
  }
  
  static showError(message) {
    return this.show(message, 'error', 7000);
  }
  
  static showSuccess(message) {
    return this.show(message, 'success', 3000);
  }
  
  // FIX: mancava ma viene chiamata (stopRecording)
  static showInfo(message) {
    return this.show(message, 'info', 4000);
  }
}

// ==========================
// GESTIONE PROPERTY DATA
// ==========================
class PropertyManager {
  static FIELDS = [
    ["f_displayName", "Nome visualizzato"],
    ["f_mq", "Metri Quadri"],
    ["f_piano", "Piano"],
    ["f_locali", "Locali"],
    ["f_bagno", "Bagno"],
    ["f_riscaldamento", "Riscaldamento"],
    ["f_giardino", "Giardino"],
    ["f_garage", "Garage/box"],
    ["f_arredamento", "Arredamento"],
    ["f_ascensore", "Ascensore"],
    ["f_libero", "Libero"],
    ["f_classeImmobile", "Classe Immobile"],
    ["f_anno", "Anno di Costruzione"],
    ["f_ristrutturato", "Ristrutturato"],
  ];
  
  static getData() {
    const data = {};
    for (const [id, label] of this.FIELDS) {
      const el = Utilities.$(id);
      if (!el) continue;
      const v = String(el.value || "").trim();
      if (v) data[label] = v;
    }
    return data;
  }
  
  static dataToText(data) {
    const entries = Object.entries(data || {});
    if (!entries.length) return "‚Äî";
    return entries.map(([k, v]) => `- ${k}: ${v}`).join("\n");
  }
  
  static updateStatus() {
    const data = this.getData();
    const count = Object.keys(data).length;
    Utilities.$("propertyStatus").textContent = count ? `Dati: ${count} compilati` : "Dati: ‚Äî";
  }
  
  static save() {
    try {
      StorageManager.set('property_data', this.getData());
    } catch (error) {
      console.error('Errore salvataggio property:', error);
    }
  }
  
  static load() {
    try {
      const data = StorageManager.get('property_data') || {};
      for (const [id, label] of this.FIELDS) {
        if (data && data[label] != null && Utilities.$(id)) {
          Utilities.$(id).value = String(data[label]);
        }
      }
    } catch (error) {
      console.error('Errore caricamento property:', error);
    }
    this.updateStatus();
  }
  
  static clear() {
    for (const [id] of this.FIELDS) {
      if (Utilities.$(id)) Utilities.$(id).value = "";
    }
    StorageManager.remove('property_data');
    this.updateStatus();
  }
}

// ==========================
// TELEPROMPTER CONTROLLER
// ==========================
class TeleprompterController {
  constructor(state) {
    this.state = state;
    this.teleText = Utilities.$('teleText');
  }
  
  reset() {
    if (this.teleText) {
      this.teleText.style.transform = "translateY(20px)";
    }
  }
  
  start() {
    if (this.state.isTeleprompterRunning) return;
    
    this.state.isTeleprompterRunning = true;
    this.state.startTimeSec = performance.now() / 1000;
    this.animate();
  }
  
  stop() {
    this.state.isTeleprompterRunning = false;
    if (this.state.teleprompterAnimationId) {
      cancelAnimationFrame(this.state.teleprompterAnimationId);
      this.state.teleprompterAnimationId = null;
    }
  }
  
  restart() {
    this.stop();
    this.reset();
    setTimeout(() => this.start(), 120);
  }
  
  animate() {
    if (!this.state.isTeleprompterRunning || !this.teleText) return;
    
    const now = performance.now() / 1000;
    const elapsed = now - this.state.startTimeSec;
    const progress = (elapsed % this.state.teleprompterSeconds) / this.state.teleprompterSeconds;
    
    const th = this.teleText.scrollHeight || 900;
    const startY = 20;
    const endY = -th - 20;
    
    const y = startY + (endY - startY) * progress;
    this.teleText.style.transform = `translateY(${y}px)`;
    
    this.state.teleprompterAnimationId = requestAnimationFrame(() => this.animate());
  }
  
  applyAnswer(answer) {
    const a = String(answer || "").trim();
    if (!a) return false;
    
    if (this.teleText) {
      this.teleText.textContent = a;
    }
    
    this.reset();
    this.stop();
    return true;
  }
}

// ==========================
// VIDEO RECORDER
// ==========================
class VideoRecorder {
  constructor(state) {
    this.state = state;
    this.canvas = Utilities.$('recCanvas');
    this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
    this.camEl = Utilities.$('cam');
  }
  
  async startCamera() {
    if (this.state.camStream) {
      this.state.camStream.getTracks().forEach(t => t.stop());
      this.state.camStream = null;
    }
    
    try {
      const constraints = {
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        },
        video: {
          facingMode: "user",
          width: { ideal: 1280 },
          height: { ideal: 720 },
          frameRate: { ideal: 30 }
        }
      };
      
      this.state.camStream = await navigator.mediaDevices.getUserMedia(constraints);
      this.camEl.srcObject = this.state.camStream;
      
      await new Promise(resolve => {
        this.camEl.onloadedmetadata = () => resolve();
      });
      
      try {
        await this.camEl.play();
      } catch (error) {
        console.warn('Errore riproduzione video:', error);
      }
      
      if (!this.state.rafCanvasId) {
        this.startCanvasLoop();
      }
      
      return true;
    } catch (error) {
      console.error('Errore accesso camera:', error);
      
      let message = "Impossibile accedere alla camera: ";
      if (error.name === 'NotAllowedError') {
        message += "Permesso negato. Controlla le impostazioni del browser.";
      } else if (error.name === 'NotFoundError') {
        message += "Nessuna camera trovata.";
      } else if (error.name === 'NotReadableError') {
        message += "Camera gi√† in uso da un'altra applicazione.";
      } else {
        message += error.message;
      }
      
      NotificationManager.showError(message);
      return false;
    }
  }
  
  startCanvasLoop() {
    const drawFrame = () => {
      const W = this.canvas.width, H = this.canvas.height;
      
      if (this.camEl.readyState < 2) {
        this.ctx.fillStyle = "black";
        this.ctx.fillRect(0, 0, W, H);
      } else {
        const vw = this.camEl.videoWidth || 1280;
        const vh = this.camEl.videoHeight || 720;
        
        const z = Math.max(1, Math.min(this.state.zoomValue, 5));
        const srcW = vw / z;
        const srcH = vh / z;
        const srcX = (vw - srcW) / 2;
        const srcY = (vh - srcH) / 2;
        
        this.ctx.drawImage(this.camEl, srcX, srcY, srcW, srcH, 0, 0, W, H);
      }
      
      this.state.rafCanvasId = requestAnimationFrame(drawFrame);
    };
    
    this.state.rafCanvasId = requestAnimationFrame(drawFrame);
  }
  
  startRecLamp() {
    this.state.recStartTs = Date.now();
    const recLamp = Utilities.$('recLamp');
    const recTime = Utilities.$('recTime');
    
    if (recLamp) recLamp.style.display = "flex";
    if (recTime) recTime.textContent = "REC 00:00";
    
    this.state.recTimerId = setInterval(() => {
      if (recTime && this.state.recStartTs) {
        recTime.textContent = `REC ${Utilities.fmtTime(Date.now() - this.state.recStartTs)}`;
      }
    }, 250);
  }
  
  stopRecLamp() {
    const recLamp = Utilities.$('recLamp');
    if (recLamp) recLamp.style.display = "none";
    
    if (this.state.recTimerId) {
      clearInterval(this.state.recTimerId);
      this.state.recTimerId = null;
    }
    this.state.recStartTs = null;
  }
  
  downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    a.remove();
    
    setTimeout(() => URL.revokeObjectURL(url), 2000);
  }
  
  buildVideoTitle(videoNum, platform, question) {
    const k = Utilities.keywordsFromQuestion(question) || "video";
    const p = platform || "noplatform";
    return `#${String(videoNum).padStart(3, "0")} ‚Ä¢ ${p} ‚Ä¢ ${k}`;
  }
  
  buildFileName(videoNum, platform, question) {
    const k = Utilities.keywordsFromQuestion(question) || "video";
    const p = platform || "noplatform";
    return `video_${String(videoNum).padStart(3, "0")}_${p}_${k}_${Utilities.nowStamp()}.webm`;
  }
  
  startRecording() {
    if (!this.state.camStream) {
      NotificationManager.showError("Attiva la camera prima di registrare.");
      return;
    }
    
    if (this.state.recorder && this.state.recorder.state !== "inactive") {
      return;
    }
    
    // Avvia teleprompter
    if (window.teleprompter) {
      window.teleprompter.start();
    }
    
    this.state.chunks = [];
    
    // Crea stream dal canvas
    const stream = this.canvas.captureStream(30);
    const audioTrack = this.state.camStream.getAudioTracks?.()[0];
    if (audioTrack) stream.addTrack(audioTrack);
    
    // Trova codec supportato
    const mimeType = CONFIG.VIDEO.MIME_TYPES.find(m => MediaRecorder.isTypeSupported(m)) || "";
    
    this.state.recorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
    
    this.state.recorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        this.state.chunks.push(e.data);
      }
    };
    
    this.state.recorder.onstart = () => {
      this.state.isRecording = true;
      this.startRecLamp();
      NotificationManager.showSuccess("Registrazione iniziata");
    };
    
    const qNow = String(this.state.currentQuestion || "").trim();
    const capNow = String(this.state.lastCaptionClean || "").trim();
    const platformNow = window.profileManager ? window.profileManager.getActivePlatform() : null;
    
    this.state.recorder.onstop = () => {
      this.stopRecLamp();
      
      if (window.teleprompter) {
        window.teleprompter.stop();
      }
      
      this.state.isRecording = false;
      
      const blob = new Blob(this.state.chunks, { type: this.state.recorder.mimeType || "video/webm" });
      this.state.totalVideos += 1;
      
      const title = this.buildVideoTitle(this.state.totalVideos, platformNow, qNow);
      const name = this.buildFileName(this.state.totalVideos, platformNow, qNow);
      const url = URL.createObjectURL(blob);
      
      this.state.recordings.unshift({
        title,
        name,
        url,
        blob,
        question: qNow,
        captionClean: capNow,
        platform: platformNow
      });
      
      this.state.currentRecIndex = 0;
      
      const playback = Utilities.$('playback');
      if (playback) {
        playback.src = url;
        playback.load();
      }
      
      if (window.recordingManager) {
        window.recordingManager.renderList();
        window.recordingManager.updateCounters();
      }
      
      if (window.profileManager) {
        window.profileManager.advancePlatform();
        window.profileManager.refreshUI();
      }
      
      NotificationManager.showSuccess("Video registrato con successo");
    };
    
    this.state.recorder.start(1000);
  }
  
  stopRecording() {
    if (this.state.recorder && this.state.recorder.state !== "inactive") {
      this.state.recorder.stop();
      NotificationManager.showInfo("Registrazione fermata");
    }
  }
  
  async ensureReady() {
    if (!this.state.camStream) {
      const ok = await this.startCamera();
      if (!ok) return false;
    }
    
    if (!this.state.rafCanvasId) {
      this.startCanvasLoop();
    }
    
    return true;
  }
}

// ==========================
// PROFILE MANAGER
// ==========================
class ProfileManager {
  constructor(state) {
    this.state = state;
    this.platforms = [
      { id: "rot_tiktok", platform: "tiktok", badgeId: "badge_tiktok" },
      { id: "rot_instagram", platform: "instagram", badgeId: "badge_instagram" },
      { id: "rot_shorts", platform: "shorts", badgeId: "badge_shorts" },
      { id: "rot_facebook", platform: "facebook", badgeId: "badge_facebook" },
    ];
  }
  
  getRotationPlatforms() {
    return this.platforms.filter(x => {
      const el = Utilities.$(x.id);
      return el && el.checked;
    });
  }
  
  getActivePlatform() {
    const list = this.getRotationPlatforms();
    if (list.length === 0) return null;
    this.state.rotationIndex = this.state.rotationIndex % list.length;
    return list[this.state.rotationIndex].platform;
  }
  
  advancePlatform() {
    const list = this.getRotationPlatforms();
    if (list.length === 0) return;
    this.state.rotationIndex = (this.state.rotationIndex + 1) % list.length;
  }
  
  setNextBadge(platform) {
    this.platforms.forEach(item => {
      const badge = Utilities.$(item.badgeId);
      if (badge) {
        badge.classList.remove("show");
      }
    });
    
    const item = this.platforms.find(x => x.platform === platform);
    if (item) {
      const badge = Utilities.$(item.badgeId);
      if (badge) {
        badge.classList.add("show");
      }
    }
  }
  
  refreshUI() {
    const active = this.getActivePlatform();
    this.setNextBadge(active);
    
    const activeLabel = Utilities.$('activeProfileLabel');
    if (activeLabel) {
      activeLabel.textContent = "Prossimo: " + (active ? active : "‚Äî");
    }
  }
}

// ==========================
// RECORDING MANAGER
// ==========================
class RecordingManager {
  constructor(state) {
    this.state = state;
  }
  
  updateCounters() {
    const videoCounter = Utilities.$('videoCounter');
    if (videoCounter) {
      videoCounter.textContent = `Video: ${this.state.totalVideos}`;
    }
  }
  
  renderList() {
    const box = Utilities.$('recList');
    if (!box) return;
    
    if (!this.state.recordings.length) {
      box.innerHTML = "‚Äî";
      return;
    }
    
    box.innerHTML = this.state.recordings.map((r, i) => {
      const active = i === this.state.currentRecIndex ? " style='color:var(--primary); font-weight:600;'" : "";
      return `
        <div ${active} style="margin-bottom:10px; padding:8px; border-radius:8px; background: ${i === this.state.currentRecIndex ? 'rgba(216, 162, 58, 0.1)' : 'transparent'}">
          <div>
            <a href="#" data-i="${i}" style="color:inherit; text-decoration:none; display:block; padding:4px;" 
               role="button" tabindex="0" aria-label="Seleziona video ${r.title}">
              ${r.title}
            </a>
          </div>
          <div style="opacity:.85; margin-top:6px; font-size:11px;">${(r.question || "").slice(0, 95)}</div>
        </div>
      `;
    }).join("");
    
    // Aggiungi event listeners
    box.querySelectorAll("a[data-i]").forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        const i = +a.dataset.i;
        this.selectRecording(i);
      });
      
      // Supporto per tastiera
      a.addEventListener("keydown", (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const i = +a.dataset.i;
          this.selectRecording(i);
        }
      });
    });
  }
  
  selectRecording(i) {
    if (i < 0 || i >= this.state.recordings.length) return;
    
    this.state.currentRecIndex = i;
    const r = this.state.recordings[i];
    
    const playback = Utilities.$('playback');
    if (playback && r.url) {
      playback.src = r.url;
      playback.load();
    }
    
    this.renderList();
  }
  
  clearList() {
    if (!this.state.recordings.length) return;
    
    if (confirm("Svuotare la lista? Tutti i video saranno rimossi.")) {
      this.state.recordings.forEach(r => {
        try { URL.revokeObjectURL(r.url); } catch (e) {}
      });
      
      this.state.recordings = [];
      this.state.currentRecIndex = -1;
      this.state.totalVideos = 0;
      
      const playback = Utilities.$('playback');
      if (playback) {
        playback.removeAttribute('src');
        playback.load();
      }
      
      this.renderList();
      this.updateCounters();
      
      if (window.profileManager) {
        window.profileManager.state.rotationIndex = 0;
        window.profileManager.refreshUI();
      }
      
      NotificationManager.showSuccess("Lista video svuotata");
    }
  }
}

// ==========================
// MAIN APPLICATION
// ==========================
class VideoCreatorApp {
  constructor() {
    this.state = new AppState();
    this.teleprompter = new TeleprompterController(this.state);
    this.videoRecorder = new VideoRecorder(this.state);
    this.profileManager = new ProfileManager(this.state);
    this.recordingManager = new RecordingManager(this.state);
    
    // Esponi per debugging
    window.appState = this.state;
    window.teleprompter = this.teleprompter;
    window.videoRecorder = this.videoRecorder;
    window.profileManager = this.profileManager;
    window.recordingManager = this.recordingManager;
  }
  
  init() {
    this.setupErrorHandling();
    this.loadPrompt();
    this.loadPropertyData();
    this.restoreCaption();
    this.setupEventListeners();
    this.initUI();
    this.setupAutoSave();
    this.setupKeyboardShortcuts();
    
    console.log(`${CONFIG.APP_NAME} v${CONFIG.VERSION} inizializzato`);
  }
  
  setupErrorHandling() {
    window.addEventListener('error', (event) => {
      console.error('Errore non gestito:', event.error);
      NotificationManager.showError('Si √® verificato un errore. Controlla la console per i dettagli.');
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Promise rejection non gestita:', event.reason);
      NotificationManager.showError('Errore imprevisto. Controlla la console per i dettagli.');
    });
  }
  
  initUI() {
    // Aggiorna profilo iniziale
    this.profileManager.refreshUI();
    // Counters
    this.recordingManager.updateCounters();
    this.recordingManager.renderList();
    // Property status
    PropertyManager.updateStatus();
    
    // Speed label
    this.setSpeed(this.state.teleprompterSeconds);
    // Zoom UI
    this.applyZoom(this.state.zoomValue);
  }
  
  setupAutoSave() {
    // Autosave property
    PropertyManager.FIELDS.forEach(([id]) => {
      const el = Utilities.$(id);
      if (el) el.addEventListener('input', () => { PropertyManager.updateStatus(); PropertyManager.save(); });
    });
    
    // Autosave answer
    Utilities.$('answerBox')?.addEventListener('input', () => {
      StorageManager.set('answer_box', Utilities.$('answerBox')?.value || '');
    });
    
    // Autosave (safety) ogni 30s
    setInterval(() => {
      try {
        PropertyManager.save();
        if (this.state.lastCaptionClean) StorageManager.set('caption_clean', this.state.lastCaptionClean);
        StorageManager.set('answer_box', Utilities.$('answerBox')?.value || '');
        StorageManager.set('rotation_index', this.state.rotationIndex || 0);
      } catch (e) {}
    }, 30000);
  }
  
  setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
      const isTyping = tag === 'input' || tag === 'textarea' || tag === 'select';
      
      // Ctrl/Cmd + S => salva prompt/caption/property (best effort)
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        PropertyManager.save();
        StorageManager.set('caption_clean', this.state.lastCaptionClean || '');
        StorageManager.set('answer_box', Utilities.$('answerBox')?.value || '');
        NotificationManager.showSuccess("Salvato");
        return;
      }
      
      // Space => start/stop teleprompter (solo se non stai scrivendo)
      if (e.code === 'Space' && !isTyping) {
        e.preventDefault();
        if (this.state.isTeleprompterRunning) this.teleprompter.stop();
        else this.teleprompter.start();
        return;
      }
      
      // ESC => chiudi modal istruzioni
      if (e.key === 'Escape') {
        this.closeInstructions();
      }
    });
  }
  
  loadPropertyData() {
    PropertyManager.load();
  }
  
  restoreCaption() {
    const saved = StorageManager.get('caption_clean');
    if (saved != null) {
      this.state.lastCaptionClean = String(saved);
      this.updateCaptionPreview();
    }
  }
  
  loadPrompt() {
    const saved = StorageManager.get('prompt_text');
    this.state.promptText = saved ? String(saved) : CONFIG.BASE_PROMPT;
    
    const promptBox = Utilities.$('promptBox');
    if (promptBox) promptBox.value = this.state.promptText;
    
    this.lockPromptUI(true);
  }
  
  lockPromptUI(locked) {
    const promptBox = Utilities.$('promptBox');
    const pill = Utilities.$('promptStatePill');
    const saveBtn = Utilities.$('btnSavePrompt');
    const resetBtn = Utilities.$('btnResetPrompt');
    
    if (promptBox) promptBox.readOnly = locked;
    if (pill) pill.textContent = locked ? "Bloccato" : "Sbloccato";
    if (saveBtn) saveBtn.disabled = locked;
    if (resetBtn) resetBtn.disabled = locked;
  }
  
  unlockPrompt() {
    const code = (Utilities.$('unlockCode')?.value || '').trim();
    if (code !== CONFIG.UNLOCK_CODE) {
      NotificationManager.showError("Codice errato.");
      return;
    }
    this.lockPromptUI(false);
    NotificationManager.showSuccess("Prompt sbloccato");
  }
  
  savePrompt() {
    const promptBox = Utilities.$('promptBox');
    if (!promptBox) return;
    this.state.promptText = promptBox.value || '';
    StorageManager.set('prompt_text', this.state.promptText);
    this.lockPromptUI(true);
    NotificationManager.showSuccess("Prompt salvato");
  }
  
  resetPrompt() {
    const promptBox = Utilities.$('promptBox');
    if (!promptBox) return;
    promptBox.value = CONFIG.BASE_PROMPT;
    this.state.promptText = CONFIG.BASE_PROMPT;
    StorageManager.set('prompt_text', this.state.promptText);
    this.lockPromptUI(true);
    NotificationManager.showSuccess("Prompt ripristinato");
  }
  
  nextQuestion() {
    this.state.qIdx = (this.state.qIdx + 1) % CONFIG.QUESTION_BANK.length;
    this.state.currentQuestion = CONFIG.QUESTION_BANK[this.state.qIdx].q;
    const qBox = Utilities.$('questionBoxOverlay');
    if (qBox) qBox.textContent = this.state.currentQuestion;
  }
  
  buildFullPromptForChatGPT() {
    const propertyData = PropertyManager.getData();
    const propertyText = PropertyManager.dataToText(propertyData);
    
    return `${this.state.promptText}

üìå DATI IMMOBILE:
${propertyText}

‚ùì DOMANDA:
${this.state.currentQuestion}
`;
  }
  
  async openChatGPT() {
    if (!this.state.currentQuestion) {
      NotificationManager.showError("Prima premi 'Nuova domanda'.");
      return;
    }
    
    const full = this.buildFullPromptForChatGPT();
    const ok = await Utilities.copyText(full);
    if (ok) {
      window.open(CONFIG.CHATGPT_URL, "_blank", "noopener,noreferrer");
      NotificationManager.showSuccess("Prompt copiato negli appunti");
    } else {
      NotificationManager.showError("Impossibile copiare negli appunti.");
    }
  }
  
  async pasteAnswer() {
    const txt = await Utilities.readClipboardText();
    if (!txt.trim()) {
      NotificationManager.showError("Appunti vuoti o permesso negato.");
      return;
    }
    const box = Utilities.$('answerBox');
    if (box) {
      box.value = txt;
      StorageManager.set('answer_box', txt);
      NotificationManager.showSuccess("Risposta incollata");
    }
  }
  
  sendToTeleprompter() {
    const a = Utilities.$('answerBox')?.value || '';
    const ok = this.teleprompter.applyAnswer(a);
    if (!ok) {
      NotificationManager.showError("Inserisci o incolla una risposta prima.");
      return;
    }
    this.extractCaptionFromAnswer(a);
    NotificationManager.showSuccess("Inviato al teleprompter");
  }
  
  extractCaptionFromAnswer(answer) {
    // Heuristica semplice: salva tutto come caption clean (senza hashtag fissi)
    const clean = String(answer || '').trim();
    this.state.lastCaptionClean = clean;
    this.updateCaptionPreview();
    
    const remember = Utilities.$('chkRememberCaption')?.checked;
    if (remember) {
      StorageManager.set('caption_clean', clean);
    }
  }
  
  updateCaptionPreview() {
    const box = Utilities.$('captionPreview');
    if (!box) return;
    box.textContent = this.state.lastCaptionClean ? this.state.lastCaptionClean : "‚Äî";
  }
  
  async copyCaption() {
    const base = String(this.state.lastCaptionClean || '').trim();
    if (!base) {
      NotificationManager.showError("Nessuna caption disponibile.");
      return;
    }
    
    // Aggiungi hashtag fissi solo se non presenti
    const hasFixed = CONFIG.HIDDEN_HASHTAGS.split(/\s+/).some(tag => base.includes(tag));
    const finalText = hasFixed ? base : `${base}\n\n${CONFIG.HIDDEN_HASHTAGS}`;
    
    const ok = await Utilities.copyText(finalText);
    if (ok) NotificationManager.showSuccess("Caption copiata");
    else NotificationManager.showError("Impossibile copiare caption.");
  }
  
  setSpeed(seconds) {
    this.state.teleprompterSeconds = seconds;
    const lbl = Utilities.$('speedLabel');
    if (lbl) lbl.textContent = `Vel: ${seconds}s`;
  }
  
  applyZoom(val) {
    const z = parseFloat(val);
    this.state.zoomValue = isFinite(z) ? z : 1.0;
    
    const cam = Utilities.$('cam');
    if (cam) cam.style.setProperty('--zoom', String(this.state.zoomValue));
    
    const zv = Utilities.$('zoomVal');
    if (zv) zv.textContent = `${this.state.zoomValue.toFixed(1)}x`;
  }
  
  async startTeleRec() {
    const ok = await this.videoRecorder.ensureReady();
    if (!ok) return;
    this.videoRecorder.startRecording();
  }
  
  downloadVideo() {
    const i = this.state.currentRecIndex;
    if (i < 0 || i >= this.state.recordings.length) {
      NotificationManager.showError("Nessun video selezionato.");
      return;
    }
    const r = this.state.recordings[i];
    if (!r || !r.blob) {
      NotificationManager.showError("Video non disponibile.");
      return;
    }
    this.videoRecorder.downloadBlob(r.blob, r.name || "video.webm");
  }
  
  handleVideoUpload(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    
    const url = URL.createObjectURL(file);
    this.state.totalVideos += 1;
    const title = `#${String(this.state.totalVideos).padStart(3, "0")} ‚Ä¢ upload ‚Ä¢ ${file.name}`;
    
    this.state.recordings.unshift({
      title,
      name: file.name,
      url,
      blob: file,
      question: "UPLOAD",
      captionClean: "",
      platform: "upload"
    });
    
    this.state.currentRecIndex = 0;
    
    const playback = Utilities.$('playback');
    if (playback) {
      playback.src = url;
      playback.load();
    }
    
    this.recordingManager.renderList();
    this.recordingManager.updateCounters();
    NotificationManager.showSuccess("Video caricato in lista");
    
    // reset input
    e.target.value = "";
  }
  
  openInstructions() {
    const modal = Utilities.$('instructionsModal');
    if (!modal) return;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
  }
  
  closeInstructions() {
    const modal = Utilities.$('instructionsModal');
    if (!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
  }
  
  setupEventListeners() {
    // Questions
    Utilities.$('btnNext')?.addEventListener('click', () => this.nextQuestion());
    
    // ChatGPT
    Utilities.$('btnOpenChatGPTPasteQ')?.addEventListener('click', () => this.openChatGPT());
    
    // Paste
    Utilities.$('btnPasteTop')?.addEventListener('click', () => this.pasteAnswer());
    
    // Teleprompter
    Utilities.$('btnSendTele')?.addEventListener('click', () => this.sendToTeleprompter());
    
    // Camera
    Utilities.$('btnCam')?.addEventListener('click', () => this.videoRecorder.ensureReady());
    
    // Recording
    Utilities.$('btnTeleRec')?.addEventListener('click', () => this.startTeleRec());
    Utilities.$('btnStop')?.addEventListener('click', () => this.videoRecorder.stopRecording());
    Utilities.$('btnRestart')?.addEventListener('click', () => this.teleprompter.restart());
    
    // Zoom
    const zoomSlider = Utilities.$('zoom');
    if (zoomSlider) {
      zoomSlider.addEventListener('input', (e) => this.applyZoom(e.target.value));
    }
    
    // Speed controls
    Utilities.$('speed120')?.addEventListener('change', (e) => {
      if (e.target.checked) this.setSpeed(120);
    });
    Utilities.$('speed105')?.addEventListener('change', (e) => {
      if (e.target.checked) this.setSpeed(105);
    });
    Utilities.$('speed90')?.addEventListener('change', (e) => {
      if (e.target.checked) this.setSpeed(90);
    });
    
    // Profile rotation
    this.profileManager.platforms.forEach(item => {
      const el = Utilities.$(item.id);
      if (el) {
        el.addEventListener('change', () => {
          this.state.rotationIndex = 0;
          this.profileManager.refreshUI();
        });
      }
    });
    
    // Caption
    Utilities.$('chkRememberCaption')?.addEventListener('change', (e) => {
      if (!e.target.checked) {
        StorageManager.remove('caption_clean');
      } else {
        StorageManager.set('caption_clean', this.state.lastCaptionClean || '');
      }
    });
    
    Utilities.$('btnCopyCaption')?.addEventListener('click', () => this.copyCaption());
    
    // Video management
    Utilities.$('btnDownloadVideo')?.addEventListener('click', () => this.downloadVideo());
    Utilities.$('btnClearList')?.addEventListener('click', () => this.recordingManager.clearList());
    
    // Property management
    Utilities.$('btnClearProperty')?.addEventListener('click', () => PropertyManager.clear());
    
    // Prompt management
    Utilities.$('btnUnlock')?.addEventListener('click', () => this.unlockPrompt());
    Utilities.$('btnSavePrompt')?.addEventListener('click', () => this.savePrompt());
    Utilities.$('btnResetPrompt')?.addEventListener('click', () => this.resetPrompt());
    
    // Instructions modal
    Utilities.$('btnInstructions')?.addEventListener('click', () => this.openInstructions());
    Utilities.$('btnCloseInstructions')?.addEventListener('click', () => this.closeInstructions());
    
    // Video upload
    Utilities.$('btnUploadVideo')?.addEventListener('click', () => {
      Utilities.$('uploadVideo')?.click();
    });
    
    Utilities.$('uploadVideo')?.addEventListener('change', (e) => this.handleVideoUpload(e));
    
    // Gestionale buttons
    const goGestionale = () => window.location.href = CONFIG.GESTIONALE_URL;
    Utilities.$('btnBackTop')?.addEventListener('click', goGestionale);
    Utilities.$('btnBackBottom')?.addEventListener('click', goGestionale);
  }
}

// Avvio app
window.addEventListener('DOMContentLoaded', () => {
  const app = new VideoCreatorApp();
  app.init();
});
</script>

</body>
</html>
