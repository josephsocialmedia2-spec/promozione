<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Video Creator ‚Äì Teleprompter</title>

  <style>
    :root {
      --bg: #0b1120;
      --text: #f3f4f6;
      --muted: #a0adb8;
      --gold: #d8a23a;
      --border: rgba(225,225,225,0.18);
      --shadow: 0 14px 50px rgba(0,0,0,0.45);
      --radius: 18px;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --tele-font: 12px;
      --tele-line: 1.22;
      --stage-w: min(420px, 92vw);
      --zoom: 1;
      --subtitle-blue: #00e5ff;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(216,162,58,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(123,79,189,.14), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(74,143,114,.14), transparent 55%),
        var(--bg);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .wrap {
      max-width: 1150px;
      margin: 0 auto;
      padding: 14px 12px 84px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    /* üîπ ICONE PI√ô PICCOLE E INTERATTIVE/ANIMATE */
    .icon-btn {
      border: none;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      padding: 6px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      position: relative;
      font-size: 16px;
      width: 32px;
      height: 32px;
    }
    .icon-btn:hover {
      background: rgba(255,255,255,0.08);
      transform: scale(1.1);
    }
    .icon-btn:active {
      transform: scale(0.95);
    }
    .icon-btn.phone {
      animation: pulse-phone 2s infinite;
    }
    .icon-btn.whatsapp {
      animation: bounce-whatsapp 1.5s infinite;
    }
    @keyframes pulse-phone {
      0%, 100% { box-shadow: 0 0 0 0 rgba(216, 162, 58, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(216, 162, 58, 0); }
    }
    @keyframes bounce-whatsapp {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    .btn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 11px;
      line-height: 1;
      white-space: nowrap;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      position: relative;
      transform: translateY(0) scale(1);
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease, border-color .14s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      overflow: hidden;
    }
    .btn::after {
      content: "";
      position: absolute;
      inset: -2px;
      background: radial-gradient(500px 140px at 20% 0%, rgba(255,255,255,.14), transparent 60%),
                  radial-gradient(500px 140px at 80% 100%, rgba(255,255,255,.10), transparent 55%);
      opacity: 0;
      transition: opacity .18s ease;
      pointer-events: none;
    }
    .btn:hover {
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(216,162,58,.22);
      box-shadow: 0 14px 34px rgba(0,0,0,.30);
      filter: brightness(1.06);
    }
    .btn:hover::after { opacity: 1; }
    .btn:active {
      transform: translateY(0px) scale(.99);
      filter: brightness(0.98);
    }

    .btn.tiny {
      padding: 6px 9px;
      font-size: 10px;
      border-radius: 11px;
      box-shadow: none;
    }

    .btn.primary {
      background: linear-gradient(135deg, rgba(216,162,58,.95), rgba(216,162,58,.72));
      color: #111;
      border-color: rgba(216,162,58,.55);
    }
    .btn.blue {
      background: linear-gradient(135deg, rgba(57,90,140,.95), rgba(57,90,140,.70));
      border-color: rgba(57,90,140,.55);
    }
    .btn.violet {
      background: linear-gradient(135deg, rgba(123,79,189,.95), rgba(123,79,189,.70));
      border-color: rgba(123,79,189,.55);
    }
    .btn.gray { background: rgba(255,255,255,.04); }

    .btn.rec {
      background: linear-gradient(135deg, rgba(255,45,45,.95), rgba(255,45,45,.55));
      border-color: rgba(255,45,45,.55);
      color: #120707;
      font-weight: 1000;
    }
    .btn.rec .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #ff2d2d;
      box-shadow: 0 0 0 0 rgba(255,45,45,.45);
      animation: pulseDot 1.15s ease-in-out infinite;
    }
    @keyframes pulseDot {
      0% { box-shadow: 0 0 0 0 rgba(255,45,45,.45); transform: scale(1); }
      60% { box-shadow: 0 0 0 10px rgba(255,45,45,0); transform: scale(1.06); }
      100% { box-shadow: 0 0 0 0 rgba(255,45,45,0); transform: scale(1); }
    }

    .btn .ico {
      display: inline-flex;
      transform: translateY(0);
      transition: transform .16s ease;
    }
    .btn:hover .ico {
      transform: translateY(-1px) rotate(-2deg);
    }

    .pill {
      font-size: 10px;
      color: var(--muted);
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      font-weight: 900;
      letter-spacing: .2px;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
    }

    .hintTop {
      margin: 6px 0 10px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.35;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 12px;
      align-items: start;
      margin-top: 12px;
    }
    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .section { padding: 12px; }
    .section + .section { border-top: 1px solid rgba(255,255,255,.10); }

    .h {
      margin: 0 0 8px;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .8px;
      font-weight: 950;
    }

    .stageRow {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 980px) { .stageRow { grid-template-columns: 1fr; } }

    .stageBlock {
      width: var(--stage-w);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    #stage916 {
      width: 100%;
      aspect-ratio: 9 / 16;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      overflow: hidden;
      position: relative;
      background: #000;
      box-shadow: var(--shadow);
    }

    #cam {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scale(var(--zoom));
      transform-origin: center;
    }

    #overlay {
      position: absolute;
      inset: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
      z-index: 2;
    }

    #questionBoxOverlay {
      font-size: 11px;
      font-weight: 950;
      line-height: 1.15;
      padding: 7px 9px;
      border-radius: 12px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(6px);
      white-space: pre-wrap;
    }

    #teleprompterOverlay {
      flex: 1;
      position: relative;
      overflow: hidden;
      border-radius: 12px;
    }

    #teleText {
      position: absolute;
      left: 0;
      right: 0;
      white-space: pre-wrap;
      font-size: var(--tele-font);
      line-height: var(--tele-line);
      font-weight: 800;
      color: rgba(243,244,246,.94);
      text-shadow: 0 2px 12px rgba(0,0,0,.75);
      transform: translateY(20px);
    }

    /* üîπ NUOVO: SOTTOTITOLO A SCORRIMENTO ORIZZONTALE */
    #subtitleOverlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.7));
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      overflow: hidden;
      z-index: 5;
    }

    #subtitleText {
      white-space: nowrap;
      font-size: 14px;
      font-weight: 900;
      color: var(--subtitle-blue);
      text-shadow: 0 0 10px rgba(0,229,255,0.5);
      padding: 10px 0;
      animation: subtitleScroll 30s linear infinite;
      background: linear-gradient(90deg, 
        rgba(0,229,255,0.1) 0%, 
        rgba(0,229,255,0.3) 25%, 
        rgba(0,229,255,0.5) 50%, 
        rgba(0,229,255,0.3) 75%, 
        rgba(0,229,255,0.1) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: absolute;
      left: 0;
    }

    @keyframes subtitleScroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    .subtitle-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      padding: 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
    }

    .subtitle-toggle {
      font-size: 10px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .controlsRow {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
    }
    .bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }
    .bar.left { justify-content: flex-start; }
    .bar.between { justify-content: space-between; }

    .sliderRow {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 10px;
      font-weight: 950;
      flex-wrap: wrap;
      justify-content: center;
    }
    input[type="range"] { width: 170px; accent-color: var(--gold); }

    .chk {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      color: var(--muted);
      font-weight: 950;
      font-size: 10px;
      white-space: nowrap;
    }
    .check {
      width: 16px;
      height: 16px;
      accent-color: var(--gold);
      cursor: pointer;
    }

    .field textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-weight: 850;
      resize: vertical;
      min-height: 120px;
      font-size: 12px;
      line-height: 1.25;
      font-family: inherit;
    }
    .field textarea:focus {
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    .mini {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      white-space: pre-wrap;
      word-break: break-word;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px;
    }

    /* üîπ SEZIONE: CONTATTO FUNZIONARIO (PARTE ALTA) */
    .agent-section {
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .agent-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }
    .agent-name {
      font-size: 11px;
      font-weight: 900;
      color: var(--text);
      white-space: nowrap;
    }
    .agent-input {
      flex: 1;
      min-width: 160px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.3);
      color: var(--text);
      font-size: 11px;
      font-weight: 700;
      outline: none;
      transition: border 0.2s ease;
    }
    .agent-input:focus {
      border-color: var(--gold);
    }
    .agent-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .property-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .property-title {
      font-size: 12px;
      font-weight: 1000;
      color: var(--text);
      margin: 0;
    }
    .property-price {
      font-size: 14px;
      font-weight: 1000;
      color: var(--gold);
      background: rgba(216,162,58,0.1);
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(216,162,58,0.3);
    }

    /* Profili piccoli */
    .profiles {
      display: grid;
      grid-template-columns: 1fr;
      gap: 7px;
      margin-top: 8px;
    }
    .profileRow {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 7px 8px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      background: rgba(0,0,0,.14);
    }
    .profileMeta {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      flex: 1;
    }
    .profileMeta b {
      font-size: 11px;
      font-weight: 950;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .nextBadge {
      font-size: 9px;
      font-weight: 1000;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,45,45,.55);
      color: rgba(255,235,235,.95);
      background: rgba(255,45,45,.18);
      white-space: nowrap;
      display: none;
      pointer-events: none;
      user-select: none;
    }
    .nextBadge.show { display: inline-flex; }

    #recLamp {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 7px 9px;
      border-radius: 12px;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(255,255,255,.18);
      font-weight: 950;
      font-size: 11px;
      display: none;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(6px);
      z-index: 6;
    }

    .bottomBar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 12px;
      background: rgba(0,0,0,.35);
      border-top: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: flex-end;
      z-index: 50;
    }

    details {
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.14);
      padding: 10px;
    }
    summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      user-select: none;
      font-weight: 950;
      color: var(--text);
      font-size: 11px;
    }
    summary::-webkit-details-marker { display: none; }
    .subtle {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.35;
      margin-top: 6px;
    }
    .codeRow {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }
    .codeRow input {
      flex: 1;
      min-width: 160px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-weight: 900;
      font-size: 12px;
      font-family: inherit;
    }
    .codeRow input:focus {
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    .ctrlLeft { display: flex; gap: 8px; align-items: center; }
    .ctrlMid { display: flex; gap: 8px; align-items: center; justify-content: center; }
    .ctrlRight { display: flex; gap: 8px; align-items: center; justify-content: flex-end; margin-left: auto; }

    /* ‚úÖ NEW: form fields */
    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    @media (max-width: 420px) { .grid2 { grid-template-columns: 1fr; } }
    .field input, .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-weight: 900;
      font-size: 12px;
      font-family: inherit;
    }
    .field input:focus, .field select:focus {
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    /* ===== ISTRUZIONI (MODAL) ===== */
    .modalBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 14px;
    }
    .modalBackdrop.show { display: flex; }

    .modalCard {
      width: min(920px, 96vw);
      max-height: min(82vh, 780px);
      overflow: auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.25));
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
    }

    .modalHead {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHead h3 {
      margin: 0;
      font-size: 12px;
      letter-spacing: .7px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 1000;
    }
    .modalBody {
      padding: 12px;
      font-size: 12px;
      line-height: 1.35;
      color: var(--text);
    }
    .modalBody .k {
      color: var(--gold);
      font-weight: 1000;
    }
    .modalBody ul { margin: 8px 0 12px 18px; }
    .modalBody li { margin: 6px 0; }
    .hr {
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- üîπ SEZIONE NUOVA: CONTATTO FUNZIONARIO (PARTE ALTA) -->
  <div class="agent-section">
    <div class="agent-left">
      <div class="agent-name">üìû Funzionario:</div>
      <input class="agent-input" id="agentNumber" type="tel" placeholder="Inserisci il tuo numero di telefono (es. +39 123 456 7890)" />
    </div>
    <div class="agent-right">
      <button class="icon-btn phone" id="btnShowPhone" title="Mostra numero per appuntamenti">üì±</button>
      <button class="icon-btn whatsapp" id="btnOpenWhatsApp" title="Apri WhatsApp con il numero">üí¨</button>
    </div>
  </div>

  <!-- üîπ NUOVA: HEADER IMMOBILE CON PREZZO -->
  <div class="property-header">
    <div>
      <h1 class="property-title" id="displayTitle">Nome Immobile</h1>
      <div class="subtle" id="propertyType">Tipologia immobile</div>
    </div>
    <div class="property-price" id="propertyPrice">‚Ç¨ 0</div>
  </div>

  <header>
    <div class="row" style="flex:1;">
      <button class="btn primary" id="btnNext" type="button">
        <span class="ico">‚ú®</span> Nuova domanda
      </button>

      <button class="btn blue" id="btnOpenChatGPTPasteQ" type="button" title="Copia PROMPT + domanda e apre ChatGPT">
        <span class="ico">üí¨</span> Apri ChatGPT + copia domanda
      </button>

      <!-- üîπ RIMOSSI: i tasti "copia" e "incolla" che hai richiesto di eliminare -->
      <button class="btn violet" id="btnPasteTop" type="button" title="Incolla dagli appunti nel blocco risposta qui sotto">
        <span class="ico">üìã</span> Incolla risposta IA
      </button>

      <!-- ‚úÖ NEW: ISTRUZIONI -->
      <button class="btn gray" id="btnInstructions" type="button" title="Apri le istruzioni operative">
        <span class="ico">üìñ</span> Istruzioni
      </button>

      <span class="pill">
        <span id="videoCounter">Video: 0</span>
        <span>‚Ä¢</span>
        <span id="activeProfileLabel">Prossimo: ‚Äî</span>
      </span>
    </div>

    <div class="row">
      <button class="btn tiny gray" id="btnBackTop" type="button">‚Üê Gestionale</button>
    </div>
  </header>

  <div class="hintTop">
    üîπ <b>Testo per il cliente:</b> "Aspetta la risposta di IA, premi <u>copia</u> su ChatGPT e <u>incolla</u> sotto in risposta IA"
  </div>

  <!-- ‚úÖ NEW: DATI IMMOBILE (RIMOSSO TASTO SPAZIO) -->
  <div class="card">
    <div class="section">
      <p class="h">Dati immobile (inseriti dal cliente)</p>

      <div class="grid2">
        <div class="field">
          <input id="f_displayName" placeholder="Nome visualizzato (es: Trilocale Luminoso)" />
        </div>
        <div class="field">
          <input id="f_price" type="text" placeholder="Prezzo (es: ‚Ç¨ 250.000)" />
        </div>

        <div class="field">
          <input id="f_mq" type="number" min="0" step="1" placeholder="Metri Quadri (mq)" />
        </div>
        <div class="field">
          <input id="f_piano" placeholder="Piano (es: 2¬∞ / rialzato / terra)" />
        </div>

        <div class="field">
          <input id="f_locali" placeholder="Locali (es: 3 / bilocale / trilocale)" />
        </div>
        <div class="field">
          <input id="f_bagno" placeholder="Bagno/i (es: 1 / 2 / 1 finestrato)" />
        </div>

        <div class="field">
          <input id="f_riscaldamento" placeholder="Riscaldamento (es: autonomo / centralizzato)" />
        </div>
        <div class="field">
          <select id="f_giardino">
            <option value="">Giardino (seleziona)</option>
            <option value="S√¨">S√¨</option>
            <option value="No">No</option>
          </select>
        </div>

        <div class="field">
          <select id="f_garage">
            <option value="">Garage/box (seleziona)</option>
            <option value="S√¨">S√¨</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="field">
          <select id="f_arredamento">
            <option value="">Arredamento (seleziona)</option>
            <option value="Arredato">Arredato</option>
            <option value="Parzialmente arredato">Parzialmente arredato</option>
            <option value="Non arredato">Non arredato</option>
          </select>
        </div>

        <div class="field">
          <select id="f_ascensore">
            <option value="">Ascensore (seleziona)</option>
            <option value="S√¨">S√¨</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="field">
          <select id="f_libero">
            <option value="">Libero (seleziona)</option>
            <option value="Subito">Subito</option>
            <option value="Da concordare">Da concordare</option>
            <option value="Occupato">Occupato</option>
          </select>
        </div>

        <div class="field">
          <input id="f_classeImmobile" placeholder="Classe Immobile (es: A4 / B / C ...)" />
        </div>
        <div class="field">
          <input id="f_anno" type="number" min="0" step="1" placeholder="Anno di Costruzione (es: 1998)" />
        </div>

        <div class="field">
          <select id="f_ristrutturato">
            <option value="">Ristrutturato (seleziona)</option>
            <option value="S√¨">S√¨</option>
            <option value="No">No</option>
            <option value="Parzialmente">Parzialmente</option>
          </select>
        </div>
      </div>

      <!-- üîπ RIMOSSO: TASTO SPAZIO -->
      <div class="bar left" style="margin-top:10px;">
        <span class="pill" id="propertyStatus">Dati: ‚Äî</span>
      </div>

      <div class="subtle">
        Questi dati vengono aggiunti automaticamente al testo che copi su ChatGPT e nel sottotitolo scorrevole.
      </div>
    </div>
  </div>

  <!-- BLOCCO RISPOSTA IN ALTO -->
  <div class="card">
    <div class="section">
      <p class="h">Risposta (da ChatGPT o scritta da te)</p>
      <div class="field">
        <textarea id="answerBox" placeholder="Qui verr√† incollata la risposta quando premi ‚ÄúIncolla risposta IA‚Äù‚Ä¶"></textarea>
      </div>

      <div class="bar left" style="margin-top:10px;">
        <button class="btn primary" id="btnSendTele" type="button"><span class="ico">‚û°Ô∏è</span> Invia al teleprompter</button>
        <button class="btn gray" id="btnCopyCaption" type="button" title="Copia caption con hashtag (se non gi√† presenti)">
          <span class="ico">üìã</span> Copia caption
        </button>
      </div>

      <div class="subtle">
        "Invia al teleprompter" ti permette anche di inserire messaggi scritti da te (non solo incollati da ChatGPT).
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- MAIN -->
    <div class="card">
      <div class="section">
        <p class="h">Video 9:16 + teleprompter + sottotitolo</p>

        <div class="stageRow">
          <div class="stageBlock">
            <div id="stage916">
              <video id="cam" autoplay playsinline muted></video>

              <!-- üîπ NUOVO: SOTTOTITOLO SCORREVOLE -->
              <div id="subtitleOverlay">
                <div id="subtitleText">Inserisci i dati dell'immobile per vedere la descrizione scorrevole qui</div>
              </div>

              <div id="recLamp">
                <span style="width:10px;height:10px;border-radius:999px;background:#ff2d2d;display:inline-block;"></span>
                <span id="recTime">REC 00:00</span>
              </div>

              <div id="overlay">
                <div id="questionBoxOverlay">Premi ‚ÄúNuova domanda‚Äù.</div>
                <div id="teleprompterOverlay">
                  <div id="teleText">Incolla/scrivi una risposta in alto ‚Üí ‚ÄúInvia al teleprompter‚Äù ‚Üí ‚ÄúTeleprompter + REC‚Äù.</div>
                </div>
              </div>
            </div>

            <!-- üîπ CONTROLLI SOTTOTITOLO -->
            <div class="subtitle-controls">
              <div class="subtitle-toggle">
                <input type="checkbox" id="subtitleToggle" class="check" checked />
                <label for="subtitleToggle">Sottotitolo scorrevole</label>
              </div>
              <div class="bar" style="flex:1; justify-content:flex-end;">
                <button class="btn tiny" id="btnGenerateSubtitle" type="button">
                  <span class="ico">üîÑ</span> Rigenera sottotitolo
                </button>
              </div>
            </div>

            <div class="controlsRow">
              <div class="bar between" style="width:100%;">
                <div class="ctrlLeft">
                  <button class="btn gray" id="btnCam" type="button"><span class="ico">üì∑</span> Camera</button>
                </div>

                <div class="ctrlMid">
                  <button class="btn gray" id="btnStop" type="button"><span class="ico">‚èπ</span> Stop</button>
                  <button class="btn gray" id="btnRestart" type="button"><span class="ico">‚Üª</span> Riavvia</button>
                </div>

                <div class="ctrlRight">
                  <button class="btn rec" id="btnTeleRec" type="button" title="Avvia teleprompter e registrazione">
                    <span class="dot"></span> Teleprompter + REC
                  </button>
                </div>
              </div>

              <div class="bar">
                <label class="chk"><input class="check" type="checkbox" id="speed120"> 120</label>
                <label class="chk"><input class="check" type="checkbox" id="speed105"> 105</label>
                <label class="chk"><input class="check" type="checkbox" id="speed90"> 90</label>
                <span class="pill" id="speedLabel">Vel: 105s</span>
              </div>

              <div class="sliderRow">
                <span>Zoom</span>
                <input id="zoom" type="range" min="1" max="2.5" step="0.1" value="1" />
                <span id="zoomVal">1.0x</span>
              </div>
            </div>
          </div>

          <div>
            <p class="h">Rotazione profili (piccola)</p>
            <div class="profiles">
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_tiktok" checked>
                <div class="profileMeta"><b>üì± TikTok</b></div>
                <span class="nextBadge" id="badge_tiktok">PROSSIMO</span>
              </div>
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_instagram" checked>
                <div class="profileMeta"><b>üì∏ Instagram</b></div>
                <span class="nextBadge" id="badge_instagram">PROSSIMO</span>
              </div>
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_shorts">
                <div class="profileMeta"><b>üé• Shorts</b></div>
                <span class="nextBadge" id="badge_shorts">PROSSIMO</span>
              </div>
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_facebook">
                <div class="profileMeta"><b>üíº Facebook</b></div>
                <span class="nextBadge" id="badge_facebook">PROSSIMO</span>
              </div>
            </div>

            <div class="subtle">
              Seleziona i canali da includere. "PROSSIMO" √® solo un indicatore (non cliccabile).
            </div>
          </div>
        </div>

        <canvas id="recCanvas" width="1080" height="1920" style="display:none;"></canvas>
      </div>
    </div>

    <!-- SIDE -->
    <div class="card">
      <div class="section">
        <div class="bar between">
          <p class="h" style="margin:0;">Caption (memorizzata)</p>
          <label class="chk" title="Memorizza la caption (senza hashtag) per il prossimo avvio">
            <input type="checkbox" id="chkRememberCaption" class="check" checked />
            Memorizza
          </label>
        </div>

        <div class="mini" id="captionPreview" style="margin-top:10px;">‚Äî</div>
        <div class="subtle">Gli hashtag automatici vengono aggiunti solo in copia (se non gi√† presenti).</div>
      </div>

      <div class="section">
        <p class="h">Video creati</p>
        <div class="subtle">Seleziona un elemento (qui sotto) per rivederlo.</div>

        <video id="playback" controls style="width:100%; border-radius:14px; background:#000; margin-top:10px;"></video>

        <div class="bar left" style="margin-top:10px;">
          <button class="btn" id="btnDownloadVideo" type="button"><span class="ico">üì•</span> Scarica video</button>
          <button class="btn tiny gray" id="btnClearList" type="button">üóëÔ∏è Svuota</button>
        </div>

        <!-- ‚úÖ NEW: UPLOAD VIDEO -->
        <div class="bar left" style="margin-top:10px;">
          <input id="uploadVideo" type="file" accept="video/*" style="display:none;" />
          <button class="btn" id="btnUploadVideo" type="button" title="Carica un video gi√† pronto (uso futuro)">
            <span class="ico">‚¨ÜÔ∏è</span> Carica video
          </button>
          <span class="pill">Upload in lista</span>
        </div>

        <div class="mini" id="recList" style="margin-top:10px; max-height:260px; overflow:auto;">‚Äî</div>
      </div>

      <div class="section">
        <details id="promptDetails">
          <summary>
            <span>üß† Prompt ChatGPT (clicca per aprire)</span>
            <span class="pill" id="promptStatePill">Bloccato</span>
          </summary>

          <div class="subtle">
            Questo prompt viene sempre inserito <b>prima</b> della domanda quando premi "Apri ChatGPT + copia domanda".
          </div>

          <div class="field" style="margin-top:10px;">
            <textarea id="promptBox" readonly></textarea>
          </div>

          <div class="codeRow">
            <input id="unlockCode" placeholder="Codice per modificare il prompt" />
            <button class="btn tiny primary" id="btnUnlock" type="button">Sblocca</button>
            <button class="btn tiny" id="btnSavePrompt" type="button" disabled>Salva</button>
            <button class="btn tiny" id="btnResetPrompt" type="button" disabled>Ripristina</button>
          </div>

          <div class="subtle">Per modificare serve il codice: <b>16091979Jm</b>.</div>
        </details>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ NEW: MODAL ISTRUZIONI -->
<div class="modalBackdrop" id="instructionsModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="instructionsTitle">
    <div class="modalHead">
      <h3 id="instructionsTitle">Istruzioni operative ‚Ä¢ Video Creator</h3>
      <button class="btn tiny gray" id="btnCloseInstructions" type="button">‚úñ Chiudi</button>
    </div>

    <div class="modalBody">
      <div class="pill" style="display:inline-flex; margin-bottom:10px;">
        Obiettivo: <b style="color:var(--text);">domanda ‚Üí testo ‚Üí teleprompter ‚Üí video pronto</b>
      </div>

      <p style="margin:0 0 8px;">
        Questa dashboard serve a creare video verticali <span class="k">9:16</span> (TikTok/Instagram/Reels/Shorts) usando
        i <span class="k">dati immobile</span> + un testo generato con <span class="k">ChatGPT</span> + un <span class="k">teleprompter</span> integrato.
      </p>

      <div class="hr"></div>

      <p class="h" style="margin:0 0 8px;">Flusso in 5 passi</p>
      <ol style="margin: 0 0 12px 18px;">
        <li><b>Compila "Dati immobile"</b> (pi√π dati = testo migliore).</li>
        <li><b>Premi "Nuova domanda"</b> finch√© trovi la domanda giusta (tour, caption, investitori, ecc.).</li>
        <li><b>Premi "Apri ChatGPT + copia domanda"</b> ‚Üí incolla su ChatGPT ‚Üí invia ‚Üí copia la risposta.</li>
        <li><b>Premi "Incolla risposta IA"</b> e poi <b>"Invia al teleprompter"</b>.</li>
        <li><b>Premi "Teleprompter + REC"</b> per registrare con teleprompter e timer REC.</li>
      </ol>

      <div class="hr"></div>

      <p class="h" style="margin:0 0 8px;">üÜï SOTTOTITOLO SCORREVOLE</p>
      <ul>
        <li>La descrizione dell'immobile scorre in orizzontale in basso nello schermo</li>
        <li>Colore: azzurro sfumato su sfondo nero lucido</li>
        <li>Si genera automaticamente dai dati immobile inseriti</li>
        <li>Puoi attivare/disattivare con l'interruttore "Sottotitolo scorrevole"</li>
        <li>Rigenera il sottotitolo con il pulsante dedicato se cambi i dati</li>
      </ul>

      <div class="hr"></div>

      <p class="h" style="margin:0 0 8px;">Controlli principali</p>
      <ul>
        <li><b>Camera</b>: accende la camera/microfono.</li>
        <li><b>Velocit√† (90/105/120)</b>: regola lo scorrimento del teleprompter.</li>
        <li><b>Zoom</b>: ingrandisce l'inquadratura (utile per non far vedere troppo sfondo).</li>
        <li><b>Stop</b>: ferma la registrazione. <b>Riavvia</b>: ricomincia lo scorrimento del teleprompter.</li>
        <li><b>Rotazione profili</b>: seleziona i canali; "PROSSIMO" indica dove andr√† il video successivo.</li>
      </ul>

      <div class="hr"></div>

      <p class="h" style="margin:0 0 8px;">Caption & Hashtag</p>
      <ul>
        <li>La caption viene memorizzata automaticamente.</li>
        <li>Gli hashtag "fissi" vengono aggiunti solo quando premi <b>Copia caption</b> (se non sono gi√† presenti).</li>
      </ul>

      <div class="hr"></div>

      <p class="h" style="margin:0 0 8px;">Upload video (gi√† pronto per uso futuro)</p>
      <p style="margin:0;">
        Puoi caricare un video esterno: verr√† inserito in <b>Video creati</b> e lo potrai rivedere/scaricare come gli altri.
      </p>
    </div>
  </div>
</div>

<div class="bottomBar">
  <button class="btn tiny gray" id="btnBackBottom" type="button">‚Üê Gestionale</button>
</div>

<script>
/* ==========================
   CONFIG
========================== */
const GESTIONALE_URL = "https://tuo-gestionale.com";
const CHATGPT_URL = "https://chatgpt.com/c/695514d7-8988-8326-98a7-ee052f64282d";

const HIDDEN_HASHTAGS = [
  "#immobiliarelasacra","#josephcretorlab","#realmediapro","#amamy","#immobiliare","#realestateitalia",
  "#mercatoimmobiliare","#agenziaimmobiliare","#casainvendita","#venditacasa","#investimentiimmobiliari",
  "#property","#realestate","#digitalstrategist","#digitalstrategy","#marketingdigitale","#strategiamarketing",
  "#brandstrategy","#contentstrategy","#socialmediastrategy","#growthmarketing","#personalbranding","#branding",
  "#businessdigitale","#marketingonline"
].join(" ");

const BASE_PROMPT = `üß© PROMPT ADATTIVO ‚Äì PROMO IMMOBILE (MAX 250 PAROLE + HASHTAG)

Agisci come un consulente immobiliare esperto e un copywriter per video social
(TikTok / Instagram / Reels).

Il tuo linguaggio deve essere:
- semplice, chiaro, super scorrevole
- comprensibile anche a un ragazzo di 15 anni
- amichevole, rassicurante, professionale
Evita tecnicismi: se usi un termine tecnico, spiegalo subito in modo semplice.

Usa SOLO i dati dell‚Äôimmobile forniti come se fossero un database interno.
Non inventare informazioni.

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
DATI IMMOBILE (DATABASE):
- Tipologia: Trilocale
- Zona: Porta Romana
- Piano: 4¬∞
- Spazi esterni: Terrazzo abitabile
- Stabile: Signorile
- Stato: Ristrutturato
- Classe energetica: A
- Disponibilit√†: Unica unit√†
- Target: Coppia / Investitore
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

OBIETTIVO:
Promuovere l‚Äôimmobile trasformando i dati in una narrazione ‚Äúvendibile‚Äù,
evidenziando benefici concreti e SCARSIT√Ä reale.

Individua automaticamente gli elementi di rarit√† usando il database
(es. terrazzo, unica unit√†, zona, combinazione di caratteristiche).

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
STRUTTURA OUTPUT:

PARTE 1 ‚Äì TESTO VIDEO (max 250 parole)
1) Hook iniziale (1‚Äì2 frasi che catturano attenzione)
2) Presentazione immobile (benefici, non elenco tecnico)
3) 2‚Äì3 punti forti in elenco (rapidi, concreti)
4) Chiusura con invito all‚Äôazione:
   scrivi ‚ÄúScrivimi in DM‚Äù oppure ‚ÄúChiamami‚Äù
5) Hashtag:
   - 5 hashtag pertinenti all‚Äôimmobile
   - + hashtag fissi: #immobiliare #casa #investimento

PARTE 2 ‚Äì SCARSIT√Ä
Crea 10 frasi di scarsit√† reale.

REGOLE SCARSIT√Ä:
- Max 12 parole per frase
- Toni naturali, non aggressivi
- Cambia sempre struttura, parole e angolazione
- Non ripetere mai frasi simili
- Usa solo dati che giustificano davvero la rarit√†
- Alterna scarsit√† basata su:
  ‚Ä¢ unicit√†
  ‚Ä¢ disponibilit√† limitata
  ‚Ä¢ difficolt√† di reperimento in zona
  ‚Ä¢ combinazione rara di caratteristiche

OUTPUT SCARSIT√Ä:
Scrivi SOLO un elenco numerato delle 10 frasi.
4) Chiusura con invito all'azione (scrivi "Scrivimi in DM" o "Chiamami")
5) Hashtag: 5 pertinenti + quelli fissi

Regole fondamentali:
- Massimo 250 parole, non di pi√π
- Tone: amichevole, rassicurante, professionale
- Niente linguaggio tecnico inutile`;

const UNLOCK_CODE = "16091979Jm";

const QUESTION_BANK = [
  { q: "Scrivimi un testo per un video di 20‚Äì30 secondi che presenti questo immobile in modo super attraente." },
  { q: "Crea una caption Instagram persuasiva per questo immobile, con call-to-action forte." },
  { q: "Fammi una versione pi√π emozionale e una pi√π "dati e concretezza" per lo stesso immobile." },
  { q: "Scrivi un testo stile "tour rapido" (come se stessi mostrando le stanze) per questo immobile." },
  { q: "Scrivi una versione pensata per chi cerca prima casa (tono rassicurante)." },
  { q: "Scrivi una versione pensata per investitori (tono pratico, focalizzato sul valore)." },
];

const TELE_SPEEDS = { s120: 120, s105: 105, s90: 90 };
let teleprompterSeconds = TELE_SPEEDS.s105;

/* State */
let qIdx = -1;
let currentQuestion = "";
let lastCaptionClean = "";
let totalVideos = 0;
let rotationIndex = 0;
let promptText = "";
let agentNumber = "";
let subtitleEnabled = true; // üîπ Sottotitolo attivo di default

/* ==========================
   HELPERS
========================== */
const $ = (id) => document.getElementById(id);

function pad2(n) { return String(n).padStart(2, "0"); }
function nowStamp() {
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}-${pad2(d.getHours())}-${pad2(d.getMinutes())}-${pad2(d.getSeconds())}`;
}

/* ==========================
   üîπ GESTIONE SOTTOTITOLO SCORREVOLE
========================== */
function generateSubtitleText() {
  const data = getPropertyData();
  if (Object.keys(data).length === 0) {
    return "Inserisci i dati dell'immobile per vedere la descrizione scorrevole qui";
  }

  const parts = [];

  // Nome e prezzo
  if (data["Nome visualizzato"]) parts.push(data["Nome visualizzato"]);
  if (data["Prezzo"]) parts.push(`‚Ä¢ ${data["Prezzo"]}`);

  // Caratteristiche principali
  const mainFeatures = [];
  if (data["Locali"]) mainFeatures.push(`${data["Locali"]} locali`);
  if (data["Metri Quadri"]) mainFeatures.push(`${data["Metri Quadri"]} m¬≤`);
  if (data["Piano"]) mainFeatures.push(`Piano ${data["Piano"]}`);
  if (data["Bagno"]) mainFeatures.push(`${data["Bagno"]} bagni`);

  if (mainFeatures.length > 0) {
    parts.push("‚Ä¢ " + mainFeatures.join(" | "));
  }

  // Caratteristiche aggiuntive
  const extraFeatures = [];
  if (data["Giardino"] === "S√¨") extraFeatures.push("Giardino");
  if (data["Garage/box"] === "S√¨") extraFeatures.push("Garage");
  if (data["Ascensore"] === "S√¨") extraFeatures.push("Ascensore");
  if (data["Arredamento"] && data["Arredamento"] !== "Non arredato") {
    extraFeatures.push(data["Arredamento"]);
  }
  if (data["Ristrutturato"] === "S√¨") extraFeatures.push("Ristrutturato");

  if (extraFeatures.length > 0) {
    parts.push("‚Ä¢ Dotazioni: " + extraFeatures.join(", "));
  }

  // Contatto
  if (agentNumber) {
    parts.push(`‚Ä¢ üìû Contatta: ${agentNumber}`);
  }

  return parts.join("   ‚≠ê   ");
}

function updateSubtitle() {
  const subtitleText = generateSubtitleText();
  $("subtitleText").textContent = subtitleText;

  // Calcola la larghezza approssimativa del testo
  const textLength = subtitleText.length;
  const animationDuration = Math.max(30, textLength * 0.5); // Durata in secondi basata sulla lunghezza

  // Applica la nuova animazione
  $("subtitleText").style.animation = `subtitleScroll ${animationDuration}s linear infinite`;
}

function toggleSubtitle() {
  subtitleEnabled = $("subtitleToggle").checked;
  if (subtitleEnabled) {
    $("subtitleOverlay").style.display = "flex";
    updateSubtitle();
  } else {
    $("subtitleOverlay").style.display = "none";
  }
}

/* ==========================
   üîπ GESTIONE FUNZIONARIO (AGENT)
========================== */
function loadAgentNumber() {
  try {
    const saved = localStorage.getItem("vc_agent_number") || "";
    if (saved) {
      agentNumber = saved;
      $("agentNumber").value = saved;
    }
  } catch (e) {}
}

function saveAgentNumber(num) {
  agentNumber = String(num || "").trim();
  try {
    localStorage.setItem("vc_agent_number", agentNumber);
  } catch (e) {}
  updateSubtitle(); // üîπ Aggiorna sottotitolo quando cambia il numero
}

function showPhoneNumber() {
  if (!agentNumber) {
    alert("Inserisci prima il numero del funzionario nel campo sopra.");
    $("agentNumber").focus();
    return;
  }
  alert(`üìû Numero del funzionario per appuntamenti:\n\n${agentNumber}\n\nInvita a chiamare o scrivere per fissare un appuntamento.`);
}

function openWhatsApp() {
  if (!agentNumber) {
    alert("Inserisci prima il numero del funzionario nel campo sopra.");
    $("agentNumber").focus();
    return;
  }
  const cleanNumber = agentNumber.replace(/\D/g, "");
  const whatsappUrl = `https://wa.me/${cleanNumber}?text=Ciao, vorrei maggiori informazioni sull'immobile.`;
  window.open(whatsappUrl, "_blank");
}

/* ==========================
   üîπ AGGIORNA HEADER IMMOBILE
========================== */
function updatePropertyHeader() {
  const name = $("f_displayName").value.trim();
  const price = $("f_price").value.trim();
  const locali = $("f_locali").value.trim();

  // Titolo
  $("displayTitle").textContent = name || "Nome Immobile";

  // Tipologia
  const typeParts = [];
  if (locali) typeParts.push(`${locali} locali`);
  const mq = $("f_mq").value.trim();
  if (mq) typeParts.push(`${mq} m¬≤`);
  const piano = $("f_piano").value.trim();
  if (piano) typeParts.push(`piano ${piano}`);

  $("propertyType").textContent = typeParts.join(" ‚Ä¢ ") || "Tipologia immobile";

  // Prezzo
  $("propertyPrice").textContent = price || "‚Ç¨ 0";
}

/* ==========================
   DATI IMMOBILE (raccolta + storage)
========================== */
const PROPERTY_FIELDS = [
  ["f_displayName", "Nome visualizzato"],
  ["f_price", "Prezzo"],
  ["f_mq", "Metri Quadri"],
  ["f_piano", "Piano"],
  ["f_locali", "Locali"],
  ["f_bagno", "Bagno"],
  ["f_riscaldamento", "Riscaldamento"],
  ["f_giardino", "Giardino"],
  ["f_garage", "Garage/box"],
  ["f_arredamento", "Arredamento"],
  ["f_ascensore", "Ascensore"],
  ["f_libero", "Libero"],
  ["f_classeImmobile", "Classe Immobile"],
  ["f_anno", "Anno di Costruzione"],
  ["f_ristrutturato", "Ristrutturato"],
];

function getPropertyData() {
  const data = {};
  for (const [id, label] of PROPERTY_FIELDS) {
    const el = $(id);
    if (!el) continue;
    const v = String(el.value || "").trim();
    if (v) data[label] = v;
  }
  return data;
}

function propertyDataToText(data) {
  const entries = Object.entries(data || {});
  if (!entries.length) return "‚Äî";
  return entries.map(([k, v]) => `- ${k}: ${v}`).join("\n");
}

function updatePropertyStatus() {
  const data = getPropertyData();
  const count = Object.keys(data).length;
  $("propertyStatus").textContent = count ? `Dati: ${count} compilati` : "Dati: ‚Äî";
  updatePropertyHeader(); // üîπ Aggiorna header
  updateSubtitle(); // üîπ Aggiorna sottotitolo
}

function savePropertyToLS() {
  try {
    localStorage.setItem("vc_property_data", JSON.stringify(getPropertyData()));
  } catch (e) {}
}

function loadPropertyFromLS() {
  try {
    const raw = localStorage.getItem("vc_property_data");
    if (!raw) return;
    const obj = JSON.parse(raw);
    for (const [id, label] of PROPERTY_FIELDS) {
      if (obj && obj[label] != null && $(id)) $(id).value = String(obj[label]);
    }
  } catch (e) {}
  updatePropertyStatus();
}

/* ==========================
   PROMPT
========================== */
function loadPrompt() {
  try {
    const saved = localStorage.getItem("vc_prompt_text");
    promptText = (saved && saved.trim()) ? saved : BASE_PROMPT;
  } catch (e) {
    promptText = BASE_PROMPT;
  }
  $("promptBox").value = promptText;
}
function lockPromptUI() {
  $("promptBox").readOnly = true;
  $("btnSavePrompt").disabled = true;
  $("btnResetPrompt").disabled = true;
  $("promptStatePill").textContent = "Bloccato";
}
function unlockPromptUI() {
  $("promptBox").readOnly = false;
  $("btnSavePrompt").disabled = false;
  $("btnResetPrompt").disabled = false;
  $("promptStatePill").textContent = "Sbloccato";
}
function savePrompt() {
  promptText = $("promptBox").value || BASE_PROMPT;
  try { localStorage.setItem("vc_prompt_text", promptText); } catch (e) {}
}

/* ==========================
   QUESTIONS
========================== */
function showQuestionInOverlay(q) {
  $("questionBoxOverlay").textContent = q ? q : "Premi "Nuova domanda".";
}
function nextQuestion() {
  qIdx = (qIdx + 1) % QUESTION_BANK.length;
  currentQuestion = QUESTION_BANK[qIdx].q;
  showQuestionInOverlay(currentQuestion);
}

function composeChatGPTInput() {
  const q = String(currentQuestion || "").trim();
  const data = getPropertyData();
  const propertyBlock = propertyDataToText(data);
  const base = (promptText || BASE_PROMPT).trim();

  const inputParts = [];
  inputParts.push("Dati immobile:");
  inputParts.push(propertyBlock);
  inputParts.push("");
  inputParts.push("Richiesta:");
  inputParts.push(`üëâ ${q || "Crea una descrizione promozionale per questo immobile."}`);

  return `${base}\n\nInput:\n${inputParts.join("\n")}`.trim();
}

/* ==========================
   ROTAZIONE PROFILI
========================== */
function getRotationPlatforms() {
  const items = [
    { id: "rot_tiktok", platform: "tiktok" },
    { id: "rot_instagram", platform: "instagram" },
    { id: "rot_shorts", platform: "shorts" },
    { id: "rot_facebook", platform: "facebook" },
  ];
  return items.filter(x => $(x.id).checked);
}
function setNextBadge(platform) {
  const map = {
    tiktok: $("badge_tiktok"),
    instagram: $("badge_instagram"),
    shorts: $("badge_shorts"),
    facebook: $("badge_facebook"),
  };
  Object.values(map).forEach(el => el.classList.remove("show"));
  if (platform && map[platform]) map[platform].classList.add("show");
}
function getActivePlatform() {
  const list = getRotationPlatforms();
  if (list.length === 0) return null;
  rotationIndex = rotationIndex % list.length;
  return list[rotationIndex].platform;
}
function advancePlatform() {
  const list = getRotationPlatforms();
  if (list.length === 0) return;
  rotationIndex = (rotationIndex + 1) % list.length;
}
function refreshProfileUI() {
  const active = getActivePlatform();
  setNextBadge(active);
  $("activeProfileLabel").textContent = "Prossimo: " + (active ? active : "‚Äî");
}

/* ==========================
   TELEPROMPTER SCROLL
========================== */
let startTimeSec = null;
let isTeleprompterRunning = false;
let teleprompterAnimationId = null;

function resetTeleprompter() {
  $("teleText").style.transform = "translateY(20px)";
}
function startTeleprompter() {
  if (isTeleprompterRunning) return;
  isTeleprompterRunning = true;
  startTimeSec = performance.now() / 1000;
  animateTele();
}
function stopTeleprompter() {
  isTeleprompterRunning = false;
  if (teleprompterAnimationId) cancelAnimationFrame(teleprompterAnimationId);
  teleprompterAnimationId = null;
}
function restartTeleprompter() {
  stopTeleprompter();
  resetTeleprompter();
  setTimeout(() => startTeleprompter(), 120);
}
function animateTele() {
  if (!isTeleprompterRunning) return;

  const teleEl = $("teleText");
  if (!teleEl) {
    teleprompterAnimationId = requestAnimationFrame(animateTele);
    return;
  }

  const now = performance.now() / 1000;
  const elapsed = now - startTimeSec;
  const progress = (elapsed % teleprompterSeconds) / teleprompterSeconds;

  const th = teleEl.scrollHeight || 900;
  const startY = 20;
  const endY = -th - 20;

  const y = startY + (endY - startY) * progress;
  teleEl.style.transform = `translateY(${y}px)`;

  teleprompterAnimationId = requestAnimationFrame(animateTele);
}

function applyAnswer(answer) {
  const a = String(answer || "").trim();
  if (!a) return false;
  $("teleText").textContent = a;
  resetTeleprompter();
  stopTeleprompter();
  setCaptionClean(a);
  return true;
}

/* ==========================
   SPEED UI
========================== */
function setSpeed(seconds) {
  teleprompterSeconds = seconds;
  $("speedLabel").textContent = `Vel: ${seconds}s`;
  $("speed120").checked = seconds === 120;
  $("speed105").checked = seconds === 105;
  $("speed90").checked = seconds === 90;
}

/* ==========================
   CAMERA + REC (CANVAS CLEAN)
========================== */
let camStream = null;
let chunks = [];
let rafCanvasId = null;
let zoomValue = 1.0;
const camEl = $("cam");
const canvas = $("recCanvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

async function applyZoom(v) {
  zoomValue = Number(v) || 1;
  $("zoomVal").textContent = `${zoomValue.toFixed(1)}x`;
  document.documentElement.style.setProperty("--zoom", String(zoomValue));
}

function drawFrame() {
  const W = canvas.width, H = canvas.height;
  if (camEl.readyState < 2) {
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, W, H);
    return;
  }
  const vw = camEl.videoWidth || 1280;
  const vh = camEl.videoHeight || 720;

  const z = Math.max(1, Math.min(zoomValue, 5));
  const srcW = vw / z;
  const srcH = vh / z;
  const srcX = (vw - srcW) / 2;
  const srcY = (vh - srcH) / 2;

  ctx.drawImage(camEl, srcX, srcY, srcW, srcH, 0, 0, W, H);

  // üîπ DISEGNA SOTTOTITOLO SUL CANVAS SE ATTIVO
  if (subtitleEnabled && $("subtitleOverlay").style.display !== "none") {
    const subtitleEl = $("subtitleText");
    const subtitleRect = $("subtitleOverlay").getBoundingClientRect();
    const stageRect = $("stage916").getBoundingClientRect();
    
    const scaleX = canvas.width / stageRect.width;
    const scaleY = canvas.height / stageRect.height;
    
    const subtitleX = (subtitleRect.left - stageRect.left) * scaleX;
    const subtitleY = (subtitleRect.top - stageRect.top) * scaleY;
    const subtitleWidth = subtitleRect.width * scaleX;
    const subtitleHeight = subtitleRect.height * scaleY;

    // Sfondo nero lucido
    ctx.fillStyle = "rgba(0,0,0,0.85)";
    ctx.fillRect(subtitleX, subtitleY, subtitleWidth, subtitleHeight);

    // Testo azzurro sfumato
    const text = subtitleEl.textContent;
    ctx.font = "bold 28px system-ui, sans-serif";
    ctx.textBaseline = "middle";
    
    // Gradiente per il testo
    const gradient = ctx.createLinearGradient(subtitleX, subtitleY, subtitleX + subtitleWidth, subtitleY);
    gradient.addColorStop(0, "#00e5ff");
    gradient.addColorStop(0.5, "#80ffff");
    gradient.addColorStop(1, "#00e5ff");
    ctx.fillStyle = gradient;
    
    // Ombra per effetto lucido
    ctx.shadowColor = "rgba(0,229,255,0.5)";
    ctx.shadowBlur = 10;
    
    // Posiziona il testo al centro verticale
    const textY = subtitleY + subtitleHeight / 2;
    
    // Calcola la posizione X per lo scorrimento
    const textWidth = ctx.measureText(text).width;
    const scrollProgress = (Date.now() % 30000) / 30000; // 30 secondi ciclo
    const textX = subtitleX + subtitleWidth - (scrollProgress * (textWidth + subtitleWidth));
    
    ctx.fillText(text, textX, textY);
    
    // Ripristina ombra
    ctx.shadowColor = "transparent";
    ctx.shadowBlur = 0;
  }
}
function startCanvasLoop() {
  function loop() {
    drawFrame();
    rafCanvasId = requestAnimationFrame(loop);
  }
  loop();
}

async function startCamera() {
  if (camStream) {
    camStream.getTracks().forEach(t => t.stop());
    camStream = null;
  }
  try {
    camStream = await navigator.mediaDevices.getUserMedia({
      audio: true,
      video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    camEl.srcObject = camStream;
    await new Promise(res => camEl.onloadedmetadata = () => res());
    try { await camEl.play(); } catch (e) {}
    if (!rafCanvasId) startCanvasLoop();
    return true;
  } catch (err) {
    alert("Errore camera: " + err.message);
    return false;
  }
}
async function ensureReady() {
  if (!camStream) {
    const ok = await startCamera();
    if (!ok) return false;
  }
  if (!rafCanvasId) startCanvasLoop();
  return true;
}

/* REC lamp */
let recStartTs = null;
let recTimerId = null;
let isRecording = false;
let recorder = null;

function fmtTime(ms) {
  const sec = Math.floor(ms / 1000);
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${m}:${s}`;
}
function startRecLamp() {
  recStartTs = Date.now();
  $("recLamp").style.display = "flex";
  $("recTime").textContent = "REC 00:00";
  recTimerId = setInterval(() => {
    $("recTime").textContent = `REC ${fmtTime(Date.now() - recStartTs)}`;
  }, 250);
}
function stopRecLamp() {
  $("recLamp").style.display = "none";
  if (recTimerId) clearInterval(recTimerId);
  recTimerId = null;
  recStartTs = null;
}

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

/* Recordings */
let recordings = [];
let currentRecIndex = -1;

function updateCounters() {
  $("videoCounter").textContent = `Video: ${totalVideos}`;
}

function renderRecList() {
  const box = $("recList");
  if (!recordings.length) { box.textContent = "‚Äî"; return; }

  box.innerHTML = recordings.map((r, i) => {
    const active = i === currentRecIndex ? " style='color:#d8a23a; font-weight:950;'" : "";
    return `
      <div ${active} style="margin-bottom:10px;">
        <div>
          <a href="#" data-i="${i}" style="color:inherit; text-decoration:none;">
            ${r.title}
          </a>
        </div>
        <div style="opacity:.85; margin-top:6px;">${(r.question || "").slice(0, 95)}</div>
      </div>
    `;
  }).join("");

  box.querySelectorAll("a[data-i]").forEach(a => a.addEventListener("click", (e) => {
    e.preventDefault();
    const i = +a.dataset.i;
    currentRecIndex = i;
    $("playback").src = recordings[i].url;
    $("playback").play().catch(() => {});
    renderRecList();
  }));
}

function buildVideoTitle(videoNum, platform, question) {
  return `#${String(videoNum).padStart(3, "0")} ‚Ä¢ ${platform || "noplatform"}`;
}
function buildFileName(videoNum, platform, question) {
  return `video_${String(videoNum).padStart(3, "0")}_${platform || "noplatform"}_${nowStamp()}.webm`;
}

function startRecording() {
  if (!camStream) { alert("Attiva la camera."); return; }
  if (recorder && recorder.state !== "inactive") { return; }

  startTeleprompter();
  chunks = [];

  const stream = canvas.captureStream(30);
  const audioTrack = camStream.getAudioTracks?.()[0];
  if (audioTrack) stream.addTrack(audioTrack);

  const mimeCandidates = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  const mimeType = mimeCandidates.find(m => MediaRecorder.isTypeSupported(m)) || "";

  recorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

  recorder.ondataavailable = (e) => { if (e.data.size) chunks.push(e.data); };
  recorder.onstart = () => { isRecording = true; startRecLamp(); };

  const qNow = String(currentQuestion || "").trim();
  const capNow = String(lastCaptionClean || "").trim();
  const platformNow = getActivePlatform();

  recorder.onstop = () => {
    stopRecLamp();
    stopTeleprompter();
    isRecording = false;

    const blob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
    totalVideos += 1;

    const title = buildVideoTitle(totalVideos, platformNow, qNow);
    const name = buildFileName(totalVideos, platformNow, qNow);
    const url = URL.createObjectURL(blob);

    recordings.unshift({ title, name, url, blob, question: qNow, captionClean: capNow, platform: platformNow });
    currentRecIndex = 0;

    $("playback").src = url;
    $("playback").load();
    renderRecList();
    updateCounters();

    advancePlatform();
    refreshProfileUI();
  };

  recorder.start(1000);
}
function stopRecording() {
  if (recorder && recorder.state !== "inactive") recorder.stop();
}

/* ==========================
   NAV
========================== */
function goToGestionale() {
  if (confirm("Vuoi tornare al gestionale?")) {
    if (isRecording) stopRecording();
    setTimeout(() => window.location.href = GESTIONALE_URL, 250);
  }
}

/* ==========================
   INIT
========================== */
document.addEventListener("DOMContentLoaded", () => {
  // prompt
  loadPrompt();
  lockPromptUI();

  // üîπ carica numero funzionario
  loadAgentNumber();

  // üîπ listeners per numero funzionario
  $("agentNumber").addEventListener("input", (e) => {
    saveAgentNumber(e.target.value);
  });
  $("btnShowPhone").addEventListener("click", showPhoneNumber);
  $("btnOpenWhatsApp").addEventListener("click", openWhatsApp);

  // üîπ listeners sottotitolo
  $("subtitleToggle").addEventListener("change", toggleSubtitle);
  $("btnGenerateSubtitle").addEventListener("click", updateSubtitle);

  // dati immobile + listeners
  loadPropertyFromLS();
  PROPERTY_FIELDS.forEach(([id]) => {
    if ($(id)) {
      $(id).addEventListener("input", () => { updatePropertyStatus(); savePropertyToLS(); });
      $(id).addEventListener("change", () => { updatePropertyStatus(); savePropertyToLS(); });
    }
  });

  // blocco risposta: vuoto di default
  $("answerBox").value = "";

  // restore caption preview only
  try {
    const savedCap = localStorage.getItem("vc_caption_clean") || "";
    if (savedCap.trim() && $("chkRememberCaption").checked) {
      setCaptionClean(savedCap);
    }
  } catch (e) {}

  // init UI
  $("btnBackTop").addEventListener("click", goToGestionale);
  $("btnBackBottom").addEventListener("click", goToGestionale);

  $("teleText").textContent = "Incolla/scrivi una risposta in alto ‚Üí "Invia al teleprompter" ‚Üí "Teleprompter + REC".";
  showQuestionInOverlay("Premi "Nuova domanda".");
  updateCounters();
  refreshProfileUI();
  renderRecList();
  resetTeleprompter();
  applyZoom(1.0);
  setSpeed(105);

  // Inizializza sottotitolo
  updateSubtitle();
  toggleSubtitle();

  // speed radio-like
  $("speed120").addEventListener("change", (e) => { if (e.target.checked) setSpeed(120); });
  $("speed105").addEventListener("change", (e) => { if (e.target.checked) setSpeed(105); });
  $("speed90").addEventListener("change", (e) => { if (e.target.checked) setSpeed(90); });

  // rotation change resets index
  ["rot_tiktok","rot_instagram","rot_shorts","rot_facebook"].forEach(id=>{
    $(id).addEventListener("change", ()=>{
      rotationIndex = 0;
      refreshProfileUI();
    });
  });

  // nuova domanda
  $("btnNext").addEventListener("click", ()=> nextQuestion());

  // apri chatgpt + copia prompt+domanda (+ dati immobile)
  $("btnOpenChatGPTPasteQ").addEventListener("click", async ()=>{
    if(!currentQuestion){
      nextQuestion();
    }
    const payload = composeChatGPTInput();
    await copyText(payload);
    window.open(CHATGPT_URL, "_blank", "noopener");
  });

  // incolla risposta
  $("btnPasteTop").addEventListener("click", async ()=>{
    try{
      const t = await readClipboardText();
      $("answerBox").value = (t || "");
    }catch(e){
      alert("Clipboard bloccata: incolla manualmente nel blocco risposta.");
    }
  });

  // invia al teleprompter
  $("btnSendTele").addEventListener("click", ()=>{
    const ok = applyAnswer($("answerBox").value || "");
    if(!ok) alert("Scrivi o incolla una risposta prima.");
  });

  // camera
  $("btnCam").addEventListener("click", async ()=>{ await ensureReady(); });

  // Teleprompter + REC
  $("btnTeleRec").addEventListener("click", async ()=>{
    const okCam = await ensureReady();
    if(!okCam) return;

    if(!currentQuestion){
      nextQuestion();
    }

    const ans = ($("answerBox").value || "").trim();
    if(!ans){
      alert("Scrivi o incolla una risposta (o usa "Incolla risposta") prima di registrare.");
      return;
    }

    applyAnswer(ans);
    startRecording();
  });

  $("btnStop").addEventListener("click", ()=> stopRecording());
  $("btnRestart").addEventListener("click", ()=> restartTeleprompter());
  $("zoom").addEventListener("input", (e)=> applyZoom(e.target.value));

  // remember caption toggle
  $("chkRememberCaption").addEventListener("change", ()=>{
    if(!$("chkRememberCaption").checked){
      try{ localStorage.removeItem("vc_caption_clean"); }catch(e){}
    }else{
      try{ localStorage.setItem("vc_caption_clean", lastCaptionClean || ""); }catch(e){}
    }
  });

  // copia caption
  $("btnCopyCaption").addEventListener("click", async ()=>{
    const out = captionWithHashtagsIfNeeded(lastCaptionClean);
    if(!out){ alert("Niente da copiare."); return; }
    await copyText(out);
  });

  // download selected video
  $("btnDownloadVideo").addEventListener("click", ()=>{
    if(currentRecIndex < 0 || !recordings[currentRecIndex]){
      alert("Seleziona un video dalla lista.");
      return;
    }
    const r = recordings[currentRecIndex];
    downloadBlob(r.blob, r.name);
  });

  // clear list
  $("btnClearList").addEventListener("click", ()=>{
    if(!recordings.length) return;
    if(confirm("Svuotare la lista?")){
      recordings.forEach(r => { try{ URL.revokeObjectURL(r.url); }catch(e){} });
      recordings = [];
      currentRecIndex = -1;
      $("playback").removeAttribute("src");
      $("playback").load();
      renderRecList();
      totalVideos = 0;
      updateCounters();
      rotationIndex = 0;
      refreshProfileUI();
    }
  });

  // prompt unlock/save/reset
  $("btnUnlock").addEventListener("click", ()=>{
    const code = ($("unlockCode").value || "").trim();
    if(code === UNLOCK_CODE){
      unlockPromptUI();
    }else{
      alert("Codice errato.");
      lockPromptUI();
    }
  });

  $("btnSavePrompt").addEventListener("click", ()=>{
    savePrompt();
    lockPromptUI();
    $("unlockCode").value = "";
  });

  $("btnResetPrompt").addEventListener("click", ()=>{
    $("promptBox").value = BASE_PROMPT;
    savePrompt();
    lockPromptUI();
    $("unlockCode").value = "";
  });

  /* ==========================
     ‚úÖ NEW: ISTRUZIONI (MODAL)
  ========================== */
  const modal = $("instructionsModal");
  function openInstructions(){
    modal.classList.add("show");
    modal.setAttribute("aria-hidden","false");
  }
  function closeInstructions(){
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
  }

  $("btnInstructions").addEventListener("click", openInstructions);
  $("btnCloseInstructions").addEventListener("click", closeInstructions);

  // Chiudi cliccando fuori dalla card
  modal.addEventListener("click", (e)=>{
    if(e.target === modal) closeInstructions();
  });

  // Chiudi con ESC
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && modal.classList.contains("show")) closeInstructions();
  });

  /* ==========================
     ‚úÖ NEW: UPLOAD VIDEO (FUTURO)
  ========================== */
  $("btnUploadVideo").addEventListener("click", ()=>{
    $("uploadVideo").click();
  });

  $("uploadVideo").addEventListener("change", ()=>{
    const file = $("uploadVideo").files && $("uploadVideo").files[0];
    if(!file) return;

    const url = URL.createObjectURL(file);

    totalVideos += 1;

    const platformNow = "upload";
    const qNow = String(currentQuestion || "").trim();
    const title = `#${String(totalVideos).padStart(3,"0")} ‚Ä¢ ${platformNow} ‚Ä¢ file`;

    recordings.unshift({
      title,
      name: file.name || `upload_${nowStamp()}.webm`,
      url,
      blob: file, // File √® un Blob: scaricabile
      question: qNow,
      captionClean: lastCaptionClean || "",
      platform: platformNow
    });

    currentRecIndex = 0;
    $("playback").src = url;
    $("playback").load();
    renderRecList();
    updateCounters();

    // reset per permettere ricarica stesso file
    $("uploadVideo").value = "";
  });

  /* ==========================
     üîπ FUNZIONI AUSILIARIE
  ========================== */
  async function copyText(text){
    const t = String(text || "");
    if(!t.trim()) return false;
    try{
      await navigator.clipboard.writeText(t);
      return true;
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      return true;
    }
  }

  async function readClipboardText(){
    return await navigator.clipboard.readText();
  }

  function captionWithHashtagsIfNeeded(clean){
    const c = String(clean || "").trim();
    if(!c) return "";

    const lower = c.toLowerCase();
    if (lower.includes("#immobiliarelasacra") || lower.includes("#josephcretorlab") || lower.includes("#realmediapro")){
      return c;
    }
    return `${c}\n\n${HIDDEN_HASHTAGS}`.trim();
  }

  function setCaptionClean(clean){
    lastCaptionClean = String(clean || "").trim();
    $("captionPreview").textContent = lastCaptionClean || "‚Äî";
    if ($("chkRememberCaption").checked){
      try{ localStorage.setItem("vc_caption_clean", lastCaptionClean); }catch(e){}
    }
  }
});
</script>
</body>
</html>
