<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Personal Brand Teleprompter</title>

  <style>
    :root {
      --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --text: #f1f5f9;
      --muted: #94a3b8;
      --primary: #8b5cf6;
      --primary-glow: rgba(139, 92, 246, 0.25);
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --surface: rgba(30, 41, 59, 0.7);
      --border: rgba(255,255,255,0.12);
      --radius: 16px;
      --shadow: 0 20px 40px rgba(0,0,0,0.3);
      --sans: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      --tele-font: 16px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      line-height: 1.5;
    }

    .wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* HEADER */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      background: rgba(15, 23, 42, 0.7);
      padding: 15px 20px;
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      font-size: 18px;
      color: var(--text);
    }
    .brand-icon {
      font-size: 24px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 13px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      border-color: var(--primary);
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #7c3aed);
      color: white;
      border: none;
    }
    .btn-success {
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      border: none;
    }
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
      border: none;
    }

    .stats {
      display: flex;
      gap: 15px;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }

    /* MAIN LAYOUT */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 25px;
    }
    @media (max-width: 1100px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    /* TELEPROMPTER SECTION */
    .teleprompter-section {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 25px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .section-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin: 0 0 20px 0;
      font-weight: 800;
    }

    .video-container {
      position: relative;
      width: 100%;
      aspect-ratio: 9/16;
      background: #000;
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 20px;
      border: 2px solid rgba(255,255,255,0.1);
    }

    #cameraFeed {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .question-display {
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.15);
      font-size: 14px;
      font-weight: 700;
      line-height: 1.4;
      text-align: center;
      margin-bottom: auto;
    }

    .teleprompter-display {
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(15px);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      font-size: var(--tele-font);
      line-height: 1.6;
      font-weight: 600;
      max-height: 40%;
      overflow-y: auto;
      margin-top: 15px;
    }
    .teleprompter-display::-webkit-scrollbar {
      width: 6px;
    }
    .teleprompter-display::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 3px;
    }
    .teleprompter-display::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    .highlight-word {
      background: rgba(139, 92, 246, 0.3);
      padding: 2px 4px;
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    /* CONTROLS */
    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 25px;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius);
    }

    .recording-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .rec-button {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
      font-weight: 800;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
      transition: all 0.3s ease;
    }
    .rec-button:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4);
    }
    .rec-button.recording {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .slider-group input[type="range"] {
      width: 150px;
      accent-color: var(--primary);
    }

    /* SIDEBAR */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 25px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .response-input {
      width: 100%;
      min-height: 180px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 14px;
      resize: vertical;
      font-family: var(--sans);
    }
    .response-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-glow);
    }

    .caption-preview {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 15px;
      font-size: 13px;
      line-height: 1.5;
      min-height: 100px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .video-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .video-item {
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    .video-item:hover {
      background: rgba(255,255,255,0.08);
      border-color: var(--border);
      transform: translateX(5px);
    }
    .video-item.active {
      background: rgba(139, 92, 246, 0.15);
      border-color: var(--primary);
    }

    .video-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
      margin-top: 5px;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 30px;
      max-width: 500px;
      width: 100%;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 800;
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-list {
      max-height: 400px;
      overflow-y: auto;
      margin: 20px 0;
    }

    .question-item {
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    .question-item:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: var(--primary);
      transform: translateX(5px);
    }

    /* UTILITY */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .timer {
      font-family: monospace;
      font-size: 14px;
      font-weight: 700;
      color: var(--danger);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* FOOTER */
    .footer-bar {
      margin-top: 40px;
      padding: 20px;
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--border);
    }
  </style>
</head>

<body>


<!-- ================= WHATSAPP CHAT BUTTON ================= -->
<a id="whatsappBtn" href="#" target="_blank" aria-label="Invia a Joseph su WhatsApp">
  <span class="wa-icon">üí¨</span>
  <span class="wa-text">Invia a Joseph</span>
</a>

<style>
#whatsappBtn{
  position: fixed;
  bottom: 90px;
  right: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: linear-gradient(135deg,#25D366,#1ebe5d);
  color: #0b1120;
  font-weight: 900;
  font-size: 12px;
  border-radius: 999px;
  text-decoration: none;
  box-shadow: 0 14px 40px rgba(0,0,0,.35);
  z-index: 9999;
  transition: transform .15s ease, box-shadow .15s ease;
}
#whatsappBtn:hover{
  transform: translateY(-2px) scale(1.03);
  box-shadow: 0 18px 50px rgba(0,0,0,.45);
}
.wa-icon{
  font-size: 18px;
  animation: waPulse 1.4s infinite;
}
@keyframes waPulse{
  0%{ transform: scale(1); }
  60%{ transform: scale(1.15); }
  100%{ transform: scale(1); }
}
</style>

<script>
const WHATSAPP_NUMBER = "+393713708294";
const WHATSAPP_TEXT = "Ciao Joseph, vorrei informazioni su questo immobile.";

const waLink =
  "https://wa.me/" +
  WHATSAPP_NUMBER.replace(/\D/g,"") +
  "?text=" + encodeURIComponent(WHATSAPP_TEXT);

document.getElementById("whatsappBtn").href = waLink;
window.WHATSAPP_LINK_FOR_CAPTION = waLink;
</script>

<div class="wrapper">

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="brand">
      <span class="brand-icon">üé¨</span>
      <span>Personal Brand Teleprompter</span>
    </div>
    
    <div class="action-buttons">
      <button class="btn btn-primary" id="newQuestionBtn">
        <span>‚ú®</span> Nuova Domanda
      </button>
      <button class="btn" id="openChatGPTBtn">
        <span>ü§ñ</span> Apri ChatGPT
      </button>
      <button class="btn" id="pasteAnswerBtn">
        <span>üìã</span> Incolla Risposta
      </button>
      <button class="btn btn-success" id="useAnswerBtn">
        <span>‚û°Ô∏è</span> Usa nel Teleprompter
      </button>
      <button class="btn" id="copyCaptionBtn">
        <span>üìù</span> Copia Caption
      </button>
    </div>

    <div class="stats">
      <div class="stat-item">
        <span>üé•</span>
        <span id="videoCount">Video: 0</span>
      </div>
      <div class="stat-item">
        <span>üöÄ</span>
        <span id="platformLabel">Social: TikTok</span>
      </div>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="main-grid">

    <!-- LEFT: TELEPROMPTER -->
    <div class="teleprompter-section">
      <h2 class="section-title">Teleprompter Live</h2>
      
      <div class="video-container">
        <video id="cameraFeed" autoplay playsinline muted></video>
        
        <div class="video-overlay">
          <div class="question-display" id="questionDisplay">
            Clicca su "Nuova Domanda" per iniziare
          </div>
          
          <div class="teleprompter-display" id="teleprompterText">
            La tua risposta apparir√† qui. <br>
            Usa il tasto "Usa nel Teleprompter" per caricarla.
          </div>
        </div>
      </div>

      <!-- CONTROLS -->
      <div class="controls-row">
        <div class="recording-controls">
          <button class="rec-button" id="recButton">
            REC
          </button>
          <div class="control-group">
            <button class="btn" id="cameraBtn">
              <span>üì∑</span> Camera
            </button>
            <button class="btn" id="flipBtn">
              <span>üîÑ</span> Gira
            </button>
          </div>
        </div>

        <div class="slider-group">
          <span>Velocit√†:</span>
          <input type="range" id="speedSlider" min="50" max="200" value="100">
          <span id="speedValue">100%</span>
        </div>

        <div class="slider-group">
          <span>Zoom:</span>
          <input type="range" id="zoomSlider" min="100" max="200" value="100">
          <span id="zoomValue">1.0x</span>
        </div>
      </div>
    </div>

    <!-- RIGHT: SIDEBAR -->
    <div class="sidebar">
      
      <!-- RESPONSE INPUT -->
      <div class="card">
        <h2 class="section-title">Risposta da ChatGPT</h2>
        <textarea class="response-input" id="responseInput" 
                  placeholder="Incolla qui la risposta da ChatGPT o scrivi il tuo testo..."></textarea>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button class="btn" id="clearTextBtn">üóëÔ∏è Pulisci</button>
          <button class="btn" id="startTeleprompterBtn">‚ñ∂Ô∏è Avvia Scorrimento</button>
          <button class="btn" id="pauseTeleprompterBtn">‚è∏Ô∏è Pausa</button>
        </div>
      </div>

      <!-- CAPTION -->
      <div class="card">
        <h2 class="section-title">Caption per Social</h2>
        <div class="caption-preview" id="captionPreview">
          La caption verr√† generata automaticamente dal testo.
        </div>
        <div style="margin-top: 15px;">
          <label class="chk">
            <input type="checkbox" id="autoHashtags" checked> 
            <span>Aggiungi hashtag automatici</span>
          </label>
        </div>
      </div>

      <!-- VIDEO LIBRARY -->
      <div class="card">
        <h2 class="section-title">Video Creati</h2>
        <div class="video-list" id="videoList">
          <div class="empty-state">
            <div class="empty-state-icon">üé•</div>
            <p>Nessun video ancora creato</p>
          </div>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button class="btn" id="playSelectedBtn">‚ñ∂Ô∏è Riproduci</button>
          <button class="btn" id="downloadSelectedBtn">üì• Scarica</button>
        </div>
      </div>

      <!-- SOCIAL PLATFORM -->
      <div class="card">
        <h2 class="section-title">Piattaforma Social</h2>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn platform-btn active" data-platform="tiktok">TikTok</button>
          <button class="btn platform-btn" data-platform="instagram">Instagram</button>
          <button class="btn platform-btn" data-platform="youtube">YouTube Shorts</button>
          <button class="btn platform-btn" data-platform="linkedin">LinkedIn</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer-bar">
    <p>Personal Brand Teleprompter ‚Ä¢ Crea contenuti coinvolgenti per i tuoi social ‚Ä¢ Vai oltre i semplici video</p>
  </div>
</div>

<!-- MODAL FOR QUESTIONS -->
<div class="modal" id="questionsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">üìö Libreria Domande</h2>
      <button class="close-modal" id="closeModalBtn">√ó</button>
    </div>
    <p>Scegli una domanda da cui iniziare il tuo video:</p>
    <div class="question-list" id="questionsList">
      <!-- Questions will be loaded here -->
    </div>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn" id="randomQuestionBtn">üé≤ Domanda Casuale</button>
      <button class="btn btn-primary" id="selectQuestionBtn">Seleziona</button>
    </div>
  </div>
</div>

<!-- VIDEO PLAYER MODAL -->
<div class="modal" id="videoModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="videoModalTitle">Anteprima Video</h2>
      <button class="close-modal" id="closeVideoModalBtn">√ó</button>
    </div>
    <video id="videoPlayer" controls style="width: 100%; border-radius: 12px;"></video>
    <div style="margin-top: 20px; display: flex; gap: 10px;">
      <button class="btn btn-primary" id="downloadVideoBtn">üì• Scarica Video</button>
      <button class="btn" id="shareVideoBtn">üîó Condividi</button>
    </div>
  </div>
</div>

<script>
// ================= CONFIGURATION =================
const CONFIG = {
  chatGPTUrl: "https://chat.openai.com/",
  defaultSpeed: 100, // percentage
  recordingDuration: 60, // seconds
  platforms: ['tiktok', 'instagram', 'youtube', 'linkedin'],
  hashtags: {
    personalbranding: [
      "#PersonalBranding", "#BrandPersonale", "#CostruzioneMarca", "#MarcaPersonale",
      "#Autorit√†Digitale", "#EspertoDelSettore", "#ContentStrategy", "#SocialMediaTips"
    ],
    business: [
      "#BusinessTips", "#Imprenditoria", "#StrategiaDigitale", "#MarketingDigitale",
      "#CrescitaProfessionale", "#Networking", "#Successo", "#Mindset"
    ],
    motivation: [
      "#Motivazione", "#CrescitaPersonale", "#SviluppoPersonale", "#Obiettivi",
      "#Produttivit√†", "#MindsetVincente", "#SuperareSfide", "#Mentalit√†DiSuccesso"
    ]
  }
};

// ================= STATE MANAGEMENT =================
let state = {
  currentQuestion: null,
  currentResponse: '',
  isRecording: false,
  isTeleprompterRunning: false,
  teleprompterPosition: 0,
  teleprompterSpeed: CONFIG.defaultSpeed,
  selectedPlatform: 'tiktok',
  videos: [],
  cameraActive: false,
  cameraStream: null,
  recorder: null,
  recordingChunks: [],
  currentVideoIndex: -1
};

// ================= DOM ELEMENTS =================
const elements = {
  // Buttons
  newQuestionBtn: document.getElementById('newQuestionBtn'),
  openChatGPTBtn: document.getElementById('openChatGPTBtn'),
  pasteAnswerBtn: document.getElementById('pasteAnswerBtn'),
  useAnswerBtn: document.getElementById('useAnswerBtn'),
  copyCaptionBtn: document.getElementById('copyCaptionBtn'),
  recButton: document.getElementById('recButton'),
  cameraBtn: document.getElementById('cameraBtn'),
  flipBtn: document.getElementById('flipBtn'),
  clearTextBtn: document.getElementById('clearTextBtn'),
  startTeleprompterBtn: document.getElementById('startTeleprompterBtn'),
  pauseTeleprompterBtn: document.getElementById('pauseTeleprompterBtn'),
  playSelectedBtn: document.getElementById('playSelectedBtn'),
  downloadSelectedBtn: document.getElementById('downloadSelectedBtn'),
  
  // Inputs
  responseInput: document.getElementById('responseInput'),
  speedSlider: document.getElementById('speedSlider'),
  zoomSlider: document.getElementById('zoomSlider'),
  autoHashtags: document.getElementById('autoHashtags'),
  
  // Displays
  questionDisplay: document.getElementById('questionDisplay'),
  teleprompterText: document.getElementById('teleprompterText'),
  captionPreview: document.getElementById('captionPreview'),
  videoList: document.getElementById('videoList'),
  videoCount: document.getElementById('videoCount'),
  platformLabel: document.getElementById('platformLabel'),
  speedValue: document.getElementById('speedValue'),
  zoomValue: document.getElementById('zoomValue'),
  
  // Camera
  cameraFeed: document.getElementById('cameraFeed'),
  
  // Modals
  questionsModal: document.getElementById('questionsModal'),
  questionsList: document.getElementById('questionsList'),
  closeModalBtn: document.getElementById('closeModalBtn'),
  randomQuestionBtn: document.getElementById('randomQuestionBtn'),
  selectQuestionBtn: document.getElementById('selectQuestionBtn'),
  videoModal: document.getElementById('videoModal'),
  videoPlayer: document.getElementById('videoPlayer'),
  closeVideoModalBtn: document.getElementById('closeVideoModalBtn'),
  downloadVideoBtn: document.getElementById('downloadVideoBtn'),
  shareVideoBtn: document.getElementById('shareVideoBtn'),
  videoModalTitle: document.getElementById('videoModalTitle')
};

// ================= QUESTION BANK =================
const QUESTIONS = [
  {
    category: "Personal Branding",
    questions: [
      "Come hai costruito la tua autorevolezza nel settore?",
      "Qual √® il segreto per essere riconoscibili sui social?",
      "Come trasformare la propria passione in una professione?",
      "Qual √® l'errore pi√π comune che vedi nel personal branding?",
      "Come superare la paura di esporsi online?",
      "Qual √® il primo step per creare un personal branding efficace?"
    ]
  },
  {
    category: "Business",
    questions: [
      "Qual √® la strategia di pricing pi√π efficace per i servizi?",
      "Come trovare i clienti ideali senza spendere in pubblicit√†?",
      "Qual √® la skill pi√π sottovalutata per fare business oggi?",
      "Come scalare un'attivit√† senza perdere qualit√†?",
      "Qual √® il miglior consiglio per chi inizia un business?",
      "Come differenziarsi dalla concorrenza in un mercato saturo?"
    ]
  },
  {
    category: "Mindset",
    questions: [
      "Come mantenere la costanza quando non si vedono risultati?",
      "Qual √® la tua routine mattutina per la produttivit√†?",
      "Come gestire il burnout quando si lavora su se stessi?",
      "Qual √® il mindset che ti ha aiutato di pi√π nel tuo percorso?",
      "Come superare l'ansia da prestazione sui social?",
      "Qual √® l'abitudine che ha cambiato radicalmente la tua vita?"
    ]
  },
  {
    category: "Content Creation",
    questions: [
      "Come trovare idee per contenuti quando sei a secco?",
      "Qual √® il formato di contenuto pi√π efficace per coinvolgere?",
      "Come aumentare la retention nei tuoi video?",
      "Qual √® il segreto per un hook perfetto?",
      "Come bilanciare contenuto di valore e intrattenimento?",
      "Qual √® la metrica pi√π importante da monitorare?"
    ]
  },
  {
    category: "Networking",
    questions: [
      "Come costruire relazioni autentiche nel tuo settore?",
      "Qual √® il modo migliore per approcciare un esperto?",
      "Come trasformare un contatto in una collaborazione?",
      "Qual √® l'errore da evitare nel networking online?",
      "Come mantenere vive le relazioni professionali?",
      "Dove trovare le persone giuste con cui connetterti?"
    ]
  }
];

// ================= INITIALIZATION =================
function init() {
  loadSavedState();
  setupEventListeners();
  updateUI();
  generateQuestionsList();
}

function loadSavedState() {
  const saved = localStorage.getItem('teleprompterState');
  if (saved) {
    const parsed = JSON.parse(saved);
    state = { ...state, ...parsed };
    state.videos = state.videos || [];
  }
  
  // Load videos from localStorage
  const savedVideos = localStorage.getItem('teleprompterVideos');
  if (savedVideos) {
    state.videos = JSON.parse(savedVideos);
    updateVideoList();
  }
}

function saveState() {
  const toSave = {
    currentResponse: state.currentResponse,
    selectedPlatform: state.selectedPlatform,
    teleprompterSpeed: state.teleprompterSpeed,
    videos: state.videos
  };
  localStorage.setItem('teleprompterState', JSON.stringify(toSave));
  localStorage.setItem('teleprompterVideos', JSON.stringify(state.videos));
}

// ================= EVENT LISTENERS =================
function setupEventListeners() {
  // Question Management
  elements.newQuestionBtn.addEventListener('click', showQuestionsModal);
  elements.openChatGPTBtn.addEventListener('click', openChatGPT);
  elements.pasteAnswerBtn.addEventListener('click', pasteFromClipboard);
  elements.useAnswerBtn.addEventListener('click', useResponseInTeleprompter);
  elements.copyCaptionBtn.addEventListener('click', copyCaption);
  
  // Camera & Recording
  elements.cameraBtn.addEventListener('click', toggleCamera);
  elements.flipBtn.addEventListener('click', flipCamera);
  elements.recButton.addEventListener('click', toggleRecording);
  
  // Teleprompter Controls
  elements.clearTextBtn.addEventListener('click', clearResponse);
  elements.startTeleprompterBtn.addEventListener('click', startTeleprompter);
  elements.pauseTeleprompterBtn.addEventListener('click', pauseTeleprompter);
  
  // Settings
  elements.speedSlider.addEventListener('input', updateSpeed);
  elements.zoomSlider.addEventListener('input', updateZoom);
  elements.autoHashtags.addEventListener('change', updateCaption);
  
  // Platform Selection
  document.querySelectorAll('.platform-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      state.selectedPlatform = e.target.dataset.platform;
      updatePlatformLabel();
      saveState();
    });
  });
  
  // Video Management
  elements.playSelectedBtn.addEventListener('click', playSelectedVideo);
  elements.downloadSelectedBtn.addEventListener('click', downloadSelectedVideo);
  
  // Modal Controls
  elements.closeModalBtn.addEventListener('click', () => elements.questionsModal.classList.remove('active'));
  elements.closeVideoModalBtn.addEventListener('click', () => elements.videoModal.classList.remove('active'));
  elements.randomQuestionBtn.addEventListener('click', selectRandomQuestion);
  elements.selectQuestionBtn.addEventListener('click', selectCurrentQuestion);
  elements.downloadVideoBtn.addEventListener('click', downloadCurrentVideo);
  elements.shareVideoBtn.addEventListener('click', shareCurrentVideo);
  
  // Close modals on outside click
  window.addEventListener('click', (e) => {
    if (e.target === elements.questionsModal) elements.questionsModal.classList.remove('active');
    if (e.target === elements.videoModal) elements.videoModal.classList.remove('active');
  });
  
  // Auto-save on input
  elements.responseInput.addEventListener('input', (e) => {
    state.currentResponse = e.target.value;
    saveState();
  });
}

// ================= QUESTION MANAGEMENT =================
function showQuestionsModal() {
  elements.questionsModal.classList.add('active');
}

function generateQuestionsList() {
  elements.questionsList.innerHTML = '';
  
  QUESTIONS.forEach(category => {
    const categoryHeader = document.createElement('div');
    categoryHeader.style.cssText = `
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin: 20px 0 10px 0;
      font-weight: 700;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border);
    `;
    categoryHeader.textContent = category.category;
    elements.questionsList.appendChild(categoryHeader);
    
    category.questions.forEach((question, index) => {
      const item = document.createElement('div');
      item.className = 'question-item';
      item.dataset.category = category.category;
      item.dataset.index = index;
      item.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 5px;">${question}</div>
        <div style="font-size: 11px; color: var(--muted);">${category.category}</div>
      `;
      item.addEventListener('click', () => {
        document.querySelectorAll('.question-item').forEach(q => q.style.background = '');
        item.style.background = 'rgba(139, 92, 246, 0.15)';
        state.currentQuestion = { category: category.category, question };
      });
      elements.questionsList.appendChild(item);
    });
  });
}

function selectRandomQuestion() {
  const category = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
  const question = category.questions[Math.floor(Math.random() * category.questions.length)];
  state.currentQuestion = { category: category.category, question };
  
  // Highlight the selected question
  document.querySelectorAll('.question-item').forEach(item => {
    if (item.dataset.category === category.category && 
        item.querySelector('div').textContent === question) {
      item.style.background = 'rgba(139, 92, 246, 0.15)';
      item.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
      item.style.background = '';
    }
  });
}

function selectCurrentQuestion() {
  if (state.currentQuestion) {
    elements.questionDisplay.textContent = state.currentQuestion.question;
    elements.questionsModal.classList.remove('active');
    updateCaption();
  }
}

// ================= CHATGPT INTEGRATION =================
function openChatGPT() {
  const prompt = state.currentQuestion 
    ? `Crea una risposta coinvolgente per un video social sulla domanda: "${state.currentQuestion.question}"\n\nLa risposta deve essere:\n- In italiano naturale e parlato\n- Durata massima 60 secondi\n- Strutturata per un teleprompter\n- Con hook iniziale forte\n- Con call to action finale\n- Adatta per ${state.selectedPlatform}`
    : "Crea un testo per un video social sul personal branding";
  
  navigator.clipboard.writeText(prompt).then(() => {
    window.open(CONFIG.chatGPTUrl, '_blank');
  });
}

async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    elements.responseInput.value = text;
    state.currentResponse = text;
    saveState();
  } catch (err) {
    alert('Non posso accedere agli appunti. Incolla manualmente.');
  }
}

function useResponseInTeleprompter() {
  const response = elements.responseInput.value.trim();
  if (!response) {
    alert('Inserisci o incolla una risposta prima.');
    return;
  }
  
  state.currentResponse = response;
  elements.teleprompterText.innerHTML = formatTeleprompterText(response);
  updateCaption();
  saveState();
}

// ================= TELEPROMPTER FUNCTIONS =================
function formatTeleprompterText(text) {
  return text.split(' ').map(word => 
    `<span class="teleprompter-word">${word}</span>`
  ).join(' ');
}

function startTeleprompter() {
  if (!state.currentResponse) {
    alert('Prima inserisci una risposta nel teleprompter.');
    return;
  }
  
  state.isTeleprompterRunning = true;
  elements.startTeleprompterBtn.disabled = true;
  elements.pauseTeleprompterBtn.disabled = false;
  
  const words = elements.teleprompterText.querySelectorAll('.teleprompter-word');
  let currentWord = 0;
  
  const interval = setInterval(() => {
    if (!state.isTeleprompterRunning) {
      clearInterval(interval);
      return;
    }
    
    // Remove highlight from previous word
    if (currentWord > 0) {
      words[currentWord - 1].classList.remove('highlight-word');
    }
    
    // Highlight current word
    if (currentWord < words.length) {
      words[currentWord].classList.add('highlight-word');
      words[currentWord].scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center',
        inline: 'center'
      });
      currentWord++;
    } else {
      // End of text
      clearInterval(interval);
      state.isTeleprompterRunning = false;
      elements.startTeleprompterBtn.disabled = false;
      elements.pauseTeleprompterBtn.disabled = true;
    }
  }, 60000 / (state.teleprompterSpeed * 10)); // Speed adjustment
}

function pauseTeleprompter() {
  state.isTeleprompterRunning = false;
  elements.startTeleprompterBtn.disabled = false;
  elements.pauseTeleprompterBtn.disabled = true;
}

function clearResponse() {
  elements.responseInput.value = '';
  elements.teleprompterText.innerHTML = 'La tua risposta apparir√† qui.';
  state.currentResponse = '';
  saveState();
}

// ================= CAPTION GENERATION =================
function updateCaption() {
  if (!state.currentResponse && !state.currentQuestion) return;
  
  let caption = '';
  
  if (state.currentQuestion) {
    caption += `üí° ${state.currentQuestion.question}\n\n`;
  }
  
  if (state.currentResponse) {
    const shortResponse = state.currentResponse.length > 200 
      ? state.currentResponse.substring(0, 200) + '...' 
      : state.currentResponse;
    caption += `${shortResponse}\n\n`;
  }
  
  // Add platform-specific tags
  switch(state.selectedPlatform) {
    case 'tiktok':
      caption += 'üéµ Suono originale - ';
      break;
    case 'instagram':
      caption += 'üëá Scorri per pi√π contenuti - ';
      break;
    case 'youtube':
      caption += '‚ñ∂Ô∏è Iscriviti per non perderti i prossimi video - ';
      break;
    case 'linkedin':
      caption += 'üîî Seguimi per altri contenuti sul personal branding - ';
      break;
  }
  
  caption += '@tuoprofilo\n\n';
  
  // Add hashtags if enabled
  if (elements.autoHashtags.checked) {
    const allHashtags = [
      ...CONFIG.hashtags.personalbranding,
      ...CONFIG.hashtags.business,
      ...CONFIG.hashtags.motivation
    ];
    
    // Select 10-15 random hashtags
    const shuffled = [...allHashtags].sort(() => 0.5 - Math.random());
    const selectedHashtags = shuffled.slice(0, 12);
    
    caption += selectedHashtags.join(' ') + '\n';
    
    // Add platform-specific hashtag
    switch(state.selectedPlatform) {
      case 'tiktok': caption += '#TikTokItalia #PerTePage'; break;
      case 'instagram': caption += '#InstagramIT #ReelsItalia'; break;
      case 'youtube': caption += '#YouTubeShorts #ShortsItalia'; break;
      case 'linkedin': caption += '#LinkedInItalia #LinkedInTips'; break;
    }
  }
  
  elements.captionPreview.textContent = caption;
}

async function copyCaption() {
  const caption = elements.captionPreview.textContent;
  if (!caption || caption === 'La caption verr√† generata automaticamente dal testo.') {
    alert('Genera prima una caption.');
    return;
  }
  
  try {
    await navigator.clipboard.writeText(caption);
    alert('Caption copiata negli appunti!');
  } catch (err) {
    alert('Errore nella copia della caption.');
  }
}

// ================= CAMERA & RECORDING =================
async function toggleCamera() {
  if (!state.cameraActive) {
    try {
      const constraints = {
        video: { 
          facingMode: "user",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: true
      };
      
      state.cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
      elements.cameraFeed.srcObject = state.cameraStream;
      state.cameraActive = true;
      elements.cameraBtn.innerHTML = '<span>üì∑</span> Stop Camera';
    } catch (err) {
      alert('Errore nell\'accesso alla camera: ' + err.message);
    }
  } else {
    if (state.cameraStream) {
      state.cameraStream.getTracks().forEach(track => track.stop());
      elements.cameraFeed.srcObject = null;
      state.cameraActive = false;
      elements.cameraBtn.innerHTML = '<span>üì∑</span> Camera';
    }
  }
}

async function flipCamera() {
  if (!state.cameraStream) return;
  
  const currentFacingMode = state.cameraStream.getVideoTracks()[0].getSettings().facingMode;
  const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
  
  // Stop current stream
  state.cameraStream.getTracks().forEach(track => track.stop());
  
  try {
    const constraints = {
      video: { 
        facingMode: newFacingMode,
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: true
    };
    
    state.cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
    elements.cameraFeed.srcObject = state.cameraStream;
  } catch (err) {
    alert('Errore nel girare la camera: ' + err.message);
  }
}

async function toggleRecording() {
  if (!state.isRecording) {
    startRecording();
  } else {
    stopRecording();
  }
}

async function startRecording() {
  if (!state.cameraStream) {
    alert('Attiva prima la camera.');
    return;
  }
  
  try {
    state.recordingChunks = [];
    
    // Combine camera feed with canvas overlay
    const canvas = document.createElement('canvas');
    canvas.width = 1080;
    canvas.height = 1920;
    const ctx = canvas.getContext('2d');
    
    const videoTrack = state.cameraStream.getVideoTracks()[0];
    const audioTrack = state.cameraStream.getAudioTracks()[0];
    
    const stream = canvas.captureStream(30);
    if (audioTrack) {
      stream.addTrack(audioTrack);
    }
    
    state.recorder = new MediaRecorder(stream, {
      mimeType: 'video/webm;codecs=vp9,opus'
    });
    
    state.recorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        state.recordingChunks.push(event.data);
      }
    };
    
    state.recorder.onstop = () => {
      const blob = new Blob(state.recordingChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      
      const videoData = {
        id: Date.now(),
        title: state.currentQuestion ? state.currentQuestion.question.substring(0, 50) : 'Video senza titolo',
        url: url,
        blob: blob,
        date: new Date().toLocaleString(),
        platform: state.selectedPlatform,
        question: state.currentQuestion?.question || '',
        caption: elements.captionPreview.textContent
      };
      
      state.videos.unshift(videoData);
      state.currentVideoIndex = 0;
      
      updateVideoList();
      saveState();
      
      // Reset recording state
      state.isRecording = false;
      elements.recButton.classList.remove('recording');
      elements.recButton.textContent = 'REC';
    };
    
    state.recorder.start(1000); // Collect data every second
    state.isRecording = true;
    elements.recButton.classList.add('recording');
    elements.recButton.textContent = '‚èπÔ∏è STOP';
    
    // Start countdown
    let timeLeft = CONFIG.recordingDuration;
    const countdown = setInterval(() => {
      timeLeft--;
      elements.recButton.textContent = `‚èπÔ∏è ${timeLeft}s`;
      
      if (timeLeft <= 0) {
        clearInterval(countdown);
        stopRecording();
      }
      
      if (!state.isRecording) {
        clearInterval(countdown);
      }
    }, 1000);
    
  } catch (err) {
    alert('Errore nella registrazione: ' + err.message);
  }
}

function stopRecording() {
  if (state.recorder && state.isRecording) {
    state.recorder.stop();
  }
}

// ================= VIDEO MANAGEMENT =================
function updateVideoList() {
  elements.videoList.innerHTML = '';
  elements.videoCount.textContent = `Video: ${state.videos.length}`;
  
  if (state.videos.length === 0) {
    elements.videoList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üé•</div>
        <p>Nessun video ancora creato</p>
      </div>
    `;
    return;
  }
  
  state.videos.forEach((video, index) => {
    const item = document.createElement('div');
    item.className = `video-item ${index === state.currentVideoIndex ? 'active' : ''}`;
    item.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 5px;">${video.title}</div>
      <div class="video-info">
        <span>${video.date}</span>
        <span style="background: rgba(139, 92, 246, 0.2); padding: 2px 8px; border-radius: 10px; font-size: 11px;">
          ${video.platform}
        </span>
      </div>
    `;
    item.addEventListener('click', () => {
      state.currentVideoIndex = index;
      updateVideoList();
    });
    elements.videoList.appendChild(item);
  });
}

function playSelectedVideo() {
  if (state.currentVideoIndex === -1 || state.videos.length === 0) {
    alert('Seleziona un video dalla lista.');
    return;
  }
  
  const video = state.videos[state.currentVideoIndex];
  elements.videoPlayer.src = video.url;
  elements.videoModalTitle.textContent = video.title;
  elements.videoModal.classList.add('active');
}

function downloadSelectedVideo() {
  if (state.currentVideoIndex === -1 || state.videos.length === 0) {
    alert('Seleziona un video dalla lista.');
    return;
  }
  
  const video = state.videos[state.currentVideoIndex];
  const a = document.createElement('a');
  a.href = video.url;
  a.download = `video-${video.id}-${state.selectedPlatform}.webm`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function downloadCurrentVideo() {
  const video = state.videos[state.currentVideoIndex];
  if (!video) return;
  
  const a = document.createElement('a');
  a.href = video.url;
  a.download = `video-${video.id}-${state.selectedPlatform}.webm`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

async function shareCurrentVideo() {
  if (navigator.share) {
    try {
      const video = state.videos[state.currentVideoIndex];
      await navigator.share({
        title: video.title,
        text: video.caption.substring(0, 100),
        url: video.url
      });
    } catch (err) {
      console.log('Condivisione annullata:', err);
    }
  } else {
    alert('La condivisione non √® supportata su questo browser.');
  }
}

// ================= SETTINGS =================
function updateSpeed() {
  state.teleprompterSpeed = elements.speedSlider.value;
  elements.speedValue.textContent = `${state.teleprompterSpeed}%`;
  saveState();
}

function updateZoom() {
  const zoom = elements.zoomSlider.value / 100;
  elements.zoomValue.textContent = `${zoom.toFixed(1)}x`;
  elements.cameraFeed.style.transform = `scale(${zoom})`;
}

function updatePlatformLabel() {
  const platformNames = {
    tiktok: 'TikTok',
    instagram: 'Instagram',
    youtube: 'YouTube Shorts',
    linkedin: 'LinkedIn'
  };
  elements.platformLabel.textContent = `Social: ${platformNames[state.selectedPlatform]}`;
}

// ================= UI UPDATES =================
function updateUI() {
  updatePlatformLabel();
  elements.speedSlider.value = state.teleprompterSpeed;
  elements.speedValue.textContent = `${state.teleprompterSpeed}%`;
  
  if (state.currentResponse) {
    elements.responseInput.value = state.currentResponse;
    elements.teleprompterText.innerHTML = formatTeleprompterText(state.currentResponse);
  }
  
  updateCaption();
  updateVideoList();
}

// ================= INITIALIZE =================
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
